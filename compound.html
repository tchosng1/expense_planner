<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1"
    />
    <title>å¤åˆ©è®¡ç®—å™¨ v4 â€” å¹´åº¦åˆ†è§£ + æŠ˜å æ¸²æŸ“</title>
    <meta
      name="description"
      content="ç§»åŠ¨ä¼˜å…ˆã€ç¦»çº¿å¯ç”¨çš„å¤åˆ©/è´·æ¬¾è®¡ç®—å™¨ã€‚æ”¯æŒæ¡£æ¡ˆç®¡ç†ã€å¯¼å…¥å¯¼å‡ºã€å¹´åº¦åˆ†è§£è¡¨ä¸å›¾è¡¨ï¼ˆå¹´åˆæœ¬é‡‘ / å¹´åˆ©æ¯ / å¹´æœ«ç´¯è®¡ï¼‰ã€‚"
    />
    <style>
      :root {
        --bg: #0b1220;
        --card: #071427;
        --accent: #06b6d4;
        --muted: #94a3b8;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC",
          "Noto Sans CJK SC", Arial;
        color: #e6eef6;
        background: linear-gradient(180deg, #051024 0%, #07142a 100%);
      }
      .app {
        max-width: 980px;
        margin: 0 auto;
        padding: 12px;
      }
      .card {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 12px;
        box-shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
      }
      h1 {
        font-size: 1.05rem;
        margin: 0 0 8px;
      }
      label {
        display: block;
        font-size: 0.88rem;
        color: var(--muted);
        margin-bottom: 6px;
      }
      input,
      select,
      button {
        font-size: 0.95rem;
      }
      input,
      select {
        width: 100%;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.04);
        background: transparent;
        color: inherit;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
      }
      .row {
        display: flex;
        gap: 8px;
      }
      .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      button {
        background: var(--accent);
        color: #04233a;
        padding: 8px 12px;
        border-radius: 10px;
        border: 0;
        font-weight: 600;
      }
      .muted {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.04);
        color: var(--muted);
        padding: 8px 12px;
        border-radius: 10px;
      }
      .small {
        font-size: 0.85rem;
        color: var(--muted);
      }
      .profile-controls {
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .plot-wrap {
        height: 360px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
      }
      th,
      td {
        padding: 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        text-align: right;
      }
      th {
        color: var(--muted);
        text-align: left;
      }
      details {
        background: rgba(255, 255, 255, 0.01);
        padding: 8px;
        border-radius: 10px;
      }
      summary {
        cursor: pointer;
        padding: 6px;
        border-radius: 8px;
      }
      @media (min-width: 720px) {
        .grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div id="app" class="app">
      <div class="card">
        <h1>å¤åˆ©è®¡ç®—å™¨ v4</h1>
        <div
          style="
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
          "
        >
          <div style="display: flex; gap: 8px; align-items: center">
            <select
              v-model="activeProfileId"
              @change="onProfileSelect"
              style="min-width: 180px; padding: 8px; border-radius: 8px"
            >
              <option :value="null">-- è¯·é€‰æ‹©æ¡£æ¡ˆ --</option>
              <option v-for="p in storage.profiles" :key="p.id" :value="p.id">
                {{p.name}}
              </option>
            </select>
            <div class="profile-controls">
              <button class="muted" @click="createProfile">ğŸ†• æ–°å»º</button>
              <button
                class="muted"
                @click="duplicateProfile"
                :disabled="!activeProfileId"
              >
                ğŸ“„ å¤åˆ¶
              </button>
              <button
                class="muted"
                @click="renameCurrent"
                :disabled="!activeProfileId"
              >
                âœï¸ é‡å‘½å
              </button>
              <button
                class="muted"
                @click="deleteCurrent"
                :disabled="!activeProfileId"
              >
                âŒ åˆ é™¤
              </button>
            </div>
          </div>
          <div class="small">
            æœ¬åœ°æ¡£æ¡ˆ: {{storage.profiles.length}} â€¢ æœ€åæ›´æ–°:
            {{storage.lastUpdated||'-'}}
          </div>
        </div>

        <details open>
          <summary>è¾“å…¥å‚æ•°ï¼ˆç‚¹å‡»æ”¶èµ·ä»¥èŠ‚çœç©ºé—´ï¼‰</summary>
          <div style="margin-top: 8px">
            <div class="grid">
              <div>
                <label>åˆå§‹èµ„é‡‘ (Initial Capital)</label>
                <input
                  v-model.number="form.initial"
                  inputmode="decimal"
                  type="number"
                />
              </div>
              <div>
                <label>æ¯æœˆè¿½åŠ  (Monthly Topup)</label>
                <input
                  v-model.number="form.monthlyTopup"
                  inputmode="decimal"
                  type="number"
                />
              </div>
              <div>
                <label>å›æŠ¥ç‡ (Return Rate %)</label>
                <div class="row">
                  <input
                    v-model.number="form.returnRate"
                    inputmode="decimal"
                    type="number"
                  />
                  <select
                    v-model="form.returnRateUnit"
                    style="min-width: 140px"
                  >
                    <option value="yearly">å¹´ç‡ (Yearly)</option>
                    <option value="monthly">æœˆç‡ (Monthly)</option>
                  </select>
                </div>
              </div>
              <div>
                <label>æœŸé™ (Duration)</label>
                <div class="row">
                  <input
                    v-model.number="form.duration"
                    inputmode="decimal"
                    type="number"
                  />
                  <select v-model="form.durationUnit" style="min-width: 140px">
                    <option value="year">å¹´ (Year)</option>
                    <option value="month">æœˆ (Month)</option>
                  </select>
                </div>
              </div>
              <div>
                <label>å¤åˆ©é¢‘ç‡ (Compounding)</label>
                <select v-model="form.compounding">
                  <option value="annually">æ¯å¹´ (Annually)</option>
                  <option value="monthly">æ¯æœˆ (Monthly)</option>
                </select>
              </div>

              <div>
                <label>åˆ©æ¯è®¡ç®—åŸºå‡†</label>
                <select v-model="interestBasis">
                  <option value="start">æŒ‰å¹´åˆæœ¬é‡‘ (Start)</option>
                  <option value="startPlusAdded">
                    æŒ‰å¹´åˆæœ¬é‡‘ + å½“å¹´æ–°å¢ (Start + Added)
                  </option>
                </select>
              </div>

              <div>
                <label>æ¡£æ¡ˆåç§°</label>
                <input
                  v-model="profileNameInput"
                  placeholder="è¾“å…¥åç§°åç‚¹ã€ä¿å­˜ã€‘"
                />
              </div>
            </div>
          </div>
        </details>

        <div
          style="
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 10px;
            justify-content: flex-end;
          "
        >
          <div class="actions">
            <button @click="saveProfile">ğŸ’¾ ä¿å­˜</button>
            <button @click="onCalculate">ğŸ§® è®¡ç®—å¹¶æ¸²æŸ“</button>
            <button class="muted" @click="reloadRender">ğŸ” é‡æ–°æ¸²æŸ“</button>
            <button class="muted" @click="resetForm">ğŸ§¹ é‡ç½®</button>
          </div>
        </div>

        <div
          style="
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 10px;
            justify-content: space-between;
          "
        >
          <div class="small">
            å¯¼å…¥/å¯¼å‡º JSONï¼ˆæœ¬åœ°ç¼“å­˜ key å›ºå®šä¸º <code>compound_profiles</code>ï¼‰
          </div>
          <div style="display: flex; gap: 8px">
            <button class="muted" @click="exportToFile">â¬‡ï¸ å¯¼å‡º</button>
            <label
              class="muted"
              style="padding: 6px; border-radius: 8px; cursor: pointer"
              >â¬†ï¸ å¯¼å…¥<input
                type="file"
                @change="onImportFile"
                accept=".json"
                style="display: none"
            /></label>
          </div>
        </div>
      </div>

      <div class="card">
        <div
          style="
            display: flex;
            align-items: center;
            justify-content: space-between;
          "
        >
          <h3>å›¾è¡¨ä¸å¹´åº¦åˆ†è§£</h3>
          <div>
            <button class="muted" @click="collapsed = !collapsed">
              {{collapsed? 'å±•å¼€' : 'æŠ˜å '}}
            </button>
          </div>
        </div>

        <div v-show="!collapsed">
          <div class="plot-wrap"><canvas id="chart"></canvas></div>
          <div
            style="
              display: flex;
              justify-content: flex-end;
              margin-top: 6px;
              gap: 8px;
            "
          >
            <button class="muted" @click="toggleStack">åˆ‡æ¢å †å </button>
            <button @click="downloadPNG">ä¸‹è½½å›¾ç‰‡</button>
          </div>
        </div>

        <div v-if="timeline && timeline.rows && timeline.rows.length">
          <table>
            <thead>
              <tr>
                <th>å¹´</th>
                <th>å¹´åˆæœ¬é‡‘</th>
                <th>å½“å¹´æ–°å¢æœ¬é‡‘</th>
                <th>å½“å¹´åˆ©æ¯</th>
                <th>å¹´æœ«ç´¯è®¡æ€»é¢</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="r in timeline.rows" :key="r.year">
                <td style="text-align: left">{{r.year}}</td>
                <td style="text-align: left">
                  {{formatCurrency(r.startPrincipal)}}
                </td>
                <td>{{formatCurrency(r.added)}}</td>
                <td>{{formatCurrency(r.interest)}}</td>
                <td>{{formatCurrency(r.endBalance)}}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h3>æ¯”è¾ƒåˆ†æ</h3>
        <div class="compare-list">
          <template v-for="p in storage.profiles" :key="p.id">
            <label
              style="
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 6px;
                background: rgba(255, 255, 255, 0.02);
                border-radius: 8px;
                margin: 4px 0;
              "
            >
              <input type="checkbox" v-model="compareSelection" :value="p.id" />
              <small>{{p.name}}</small>
            </label>
          </template>
        </div>
        <div style="margin-top: 8px; display: flex; gap: 8px">
          <button @click="calculateComparison">æ¯”è¾ƒå¹¶æ¸²æŸ“</button>
          <button class="muted" @click="showComparisonSummary">
            æ˜¾ç¤ºæ¯”è¾ƒæ‘˜è¦
          </button>
        </div>
        <div v-if="comparisonSummary" style="margin-top: 8px">
          <pre style="white-space: pre-wrap">{{comparisonSummary}}</pre>
        </div>
      </div>

      <footer style="text-align: center; margin-top: 12px; color: var(--muted)">
        å»ºè®®åœ¨ HTTPS / localhost æ‰“å¼€ï¼Œé¦–æ¬¡æ‰“å¼€ä¼šç¼“å­˜ä¾èµ–ï¼Œä¹‹åå¯ç¦»çº¿ä½¿ç”¨ã€‚
      </footer>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
      const STORAGE_KEY = "compound_profiles";
      const { createApp, ref, reactive, onMounted, nextTick } = Vue;

      createApp({
        setup() {
          const CURRENT_SCHEMA_VERSION = 1;
          const storage = reactive({
            version: CURRENT_SCHEMA_VERSION,
            profiles: [],
            lastUpdated: null,
          });

          const defaultForm = () => ({
            initial: 10000,
            monthlyTopup: 0,
            returnRate: 5,
            returnRateUnit: "yearly",
            duration: 10,
            durationUnit: "year",
            compounding: "annually",
          });
          const form = reactive(defaultForm());
          const profileNameInput = ref("");
          const activeProfileId = ref(null);
          const chartInstance = ref(null);
          const stacked = ref(false);
          const comparisonSummary = ref("");
          const compareSelection = ref([]);
          const timeline = reactive({ rows: [] });
          const collapsed = ref(false);
          const interestBasis = ref("startPlusAdded");
          let lastRender = { mode: null, datasets: [], labels: [] };

          onMounted(async () => {
            const data = loadFromLocal();
            storage.version = data.version || CURRENT_SCHEMA_VERSION;
            storage.profiles = data.profiles || [];
            storage.lastUpdated = data.lastUpdated || null;
            if (storage.profiles.length > 0) {
              activeProfileId.value = storage.profiles[0].id;
              loadProfileToForm(activeProfileId.value);
            }
            await nextTick();
            initChart();
            tryRegisterSW();
          });

          // helpers
          function nowISOString() {
            return new Date().toISOString();
          }
          function formatCurrency(v) {
            if (!isFinite(v)) return "-";
            return Number(v).toLocaleString(undefined, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            });
          }

          function loadFromLocal() {
            try {
              const raw = localStorage.getItem(STORAGE_KEY);
              if (!raw)
                return {
                  version: CURRENT_SCHEMA_VERSION,
                  profiles: [],
                  lastUpdated: null,
                };
              const parsed = JSON.parse(raw);
              return migrateIfNeeded(parsed);
            } catch (e) {
              console.error("è¯»å–æœ¬åœ°æ¡£æ¡ˆå¤±è´¥", e);
              return {
                version: CURRENT_SCHEMA_VERSION,
                profiles: [],
                lastUpdated: null,
              };
            }
          }
          function saveToLocal() {
            try {
              const obj = {
                version: storage.version || CURRENT_SCHEMA_VERSION,
                profiles: storage.profiles,
                lastUpdated: nowISOString(),
              };
              localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
              storage.lastUpdated = obj.lastUpdated;
            } catch (e) {
              console.error("å†™å…¥æœ¬åœ°æ¡£æ¡ˆå¤±è´¥", e);
            }
          }
          function migrateIfNeeded(data) {
            if (!data || typeof data !== "object")
              return {
                version: CURRENT_SCHEMA_VERSION,
                profiles: [],
                lastUpdated: null,
              };
            return {
              version: data.version || 1,
              profiles: Array.isArray(data.profiles) ? data.profiles : [],
              lastUpdated: data.lastUpdated || null,
            };
          }
          function dedupeById(arr) {
            const map = new Map();
            for (const p of arr) {
              if (!p.id)
                p.id =
                  "p_" + Date.now() + Math.random().toString(36).slice(2, 9);
              map.set(p.id, p);
            }
            return Array.from(map.values());
          }

          // profile ops
          function createProfile() {
            const id = "p_" + Date.now();
            const name = "æ–°æ¡£æ¡ˆ " + new Date().toLocaleString();
            const p = Object.assign(
              { id, name },
              JSON.parse(JSON.stringify(defaultForm()))
            );
            storage.profiles.unshift(p);
            saveToLocal();
            activeProfileId.value = id;
            loadProfileToForm(id);
          }
          function onProfileSelect() {
            if (activeProfileId.value) loadProfileToForm(activeProfileId.value);
          }
          function loadProfileToForm(id) {
            const p = storage.profiles.find((x) => x.id === id);
            if (!p) return;
            profileNameInput.value = p.name;
            [
              "initial",
              "monthlyTopup",
              "returnRate",
              "returnRateUnit",
              "duration",
              "durationUnit",
              "compounding",
            ].forEach(
              (k) => (form[k] = p[k] !== undefined ? p[k] : defaultForm()[k])
            );
            setTimeout(() => {
              try {
                onCalculate();
              } catch (e) {}
            }, 50);
          }
          function saveProfile() {
            if (!profileNameInput.value && !activeProfileId.value) {
              alert("è¯·å¡«å†™æ¡£æ¡ˆåç§°æˆ–å…ˆé€‰æ‹©æ¡£æ¡ˆ");
              return;
            }
            if (!activeProfileId.value) {
              const id = "p_" + Date.now();
              const name =
                profileNameInput.value.trim() ||
                "æ¡£æ¡ˆ " + new Date().toLocaleString();
              const p = { id, name, ...JSON.parse(JSON.stringify(form)) };
              storage.profiles.unshift(p);
              activeProfileId.value = id;
              saveToLocal();
              alert("å·²æ–°å»ºå¹¶ä¿å­˜");
              return;
            }
            const p = storage.profiles.find(
              (x) => x.id === activeProfileId.value
            );
            if (p) {
              p.name = profileNameInput.value.trim() || p.name;
              [
                "initial",
                "monthlyTopup",
                "returnRate",
                "returnRateUnit",
                "duration",
                "durationUnit",
                "compounding",
              ].forEach((k) => (p[k] = form[k]));
              saveToLocal();
              alert("å·²æ›´æ–°æ¡£æ¡ˆ");
            }
          }
          function duplicateProfile() {
            if (!activeProfileId.value) return;
            const p = storage.profiles.find(
              (x) => x.id === activeProfileId.value
            );
            if (!p) return;
            const copy = JSON.parse(JSON.stringify(p));
            copy.id = "p_" + Date.now();
            copy.name = p.name + " (å¤åˆ¶)";
            storage.profiles.unshift(copy);
            saveToLocal();
          }
          function renameCurrent() {
            if (!activeProfileId.value) return;
            const p = storage.profiles.find(
              (x) => x.id === activeProfileId.value
            );
            if (!p) return;
            const nv = prompt("è¾“å…¥æ–°åç§°", p.name);
            if (nv) {
              p.name = nv;
              saveToLocal();
            }
          }
          function deleteCurrent() {
            if (!activeProfileId.value) return;
            if (!confirm("ç¡®è®¤åˆ é™¤å½“å‰æ¡£æ¡ˆï¼Ÿ")) return;
            const idx = storage.profiles.findIndex(
              (x) => x.id === activeProfileId.value
            );
            if (idx >= 0) {
              storage.profiles.splice(idx, 1);
              saveToLocal();
              activeProfileId.value = storage.profiles.length
                ? storage.profiles[0].id
                : null;
              if (activeProfileId.value)
                loadProfileToForm(activeProfileId.value);
            }
          }
          function resetForm() {
            Object.assign(form, JSON.parse(JSON.stringify(defaultForm())));
            profileNameInput.value = "";
          }

          // import/export
          function exportToFile() {
            try {
              const obj = {
                version: storage.version || CURRENT_SCHEMA_VERSION,
                profiles: storage.profiles,
                lastUpdated: nowISOString(),
              };
              const ts = new Date();
              const pad = (n, len = 2) => String(n).padStart(len, "0");
              const yyyy = ts.getFullYear(),
                MM = pad(ts.getMonth() + 1),
                dd = pad(ts.getDate()),
                hh = pad(ts.getHours()),
                mm = pad(ts.getMinutes()),
                ss = pad(ts.getSeconds()),
                fff = String(ts.getMilliseconds()).padStart(3, "0");
              const filename = `compound_profiles_${yyyy}${MM}${dd}_${hh}${mm}${ss}${fff}.json`;
              const blob = new Blob([JSON.stringify(obj, null, 2)], {
                type: "application/json",
              });
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = filename;
              a.click();
              URL.revokeObjectURL(url);
            } catch (e) {
              alert("å¯¼å‡ºå¤±è´¥ï¼š" + e.message);
            }
          }
          async function onImportFile(e) {
            const f = e.target.files && e.target.files[0];
            if (!f) return;
            try {
              const text = await f.text();
              const parsed = JSON.parse(text);
              const incoming = Array.isArray(parsed.profiles)
                ? parsed.profiles
                : Array.isArray(parsed)
                ? parsed
                : [];
              if (!incoming.length) {
                alert("å¯¼å…¥æ–‡ä»¶æ²¡æœ‰æ¡£æ¡ˆ");
                return;
              }
              const merged = dedupeById(incoming.concat(storage.profiles));
              storage.profiles.splice(0, storage.profiles.length, ...merged);
              saveToLocal();
              alert("å¯¼å…¥å¹¶åˆå¹¶æˆåŠŸ");
              if (incoming.length > 0) {
                activeProfileId.value =
                  incoming[0].id || storage.profiles[0].id;
                loadProfileToForm(activeProfileId.value);
              }
            } catch (err) {
              alert("å¯¼å…¥å¤±è´¥:" + err.message);
            }
            e.target.value = "";
          }

          // calculation: ensure end-of-year becomes next year's startPrincipal
          function computeAnnualTimeline(cfg) {
            const years = cfg.durationYears;
            const rows = [];
            let startPrincipal = cfg.initial; // year start
            let cumulativeInterest = 0;

            for (let y = 1; y <= years; y++) {
              const yearlyAdded = (cfg.monthlyTopup || 0) * 12; // assume monthlyTopup per month
              let interest = 0;

              if (cfg.compounding === "annually") {
                // annual compounding: compute interest once on basis
                if (cfg.interestBasis === "start") {
                  interest = startPrincipal * cfg.annualRate;
                } else {
                  interest = (startPrincipal + yearlyAdded) * cfg.annualRate;
                }
              } else {
                // monthly compounding: iterate 12 months
                const monthlyRate = Math.pow(1 + cfg.annualRate, 1 / 12) - 1;
                let balance = startPrincipal;
                let interestAcc = 0;
                for (let m = 1; m <= 12; m++) {
                  const topup = cfg.monthlyTopup || 0;
                  // assume topup at start of month
                  if (topup) balance += topup;
                  if (cfg.interestBasis === "start") {
                    const monInterest = startPrincipal * monthlyRate;
                    interestAcc += monInterest;
                    balance += monInterest;
                  } else {
                    const addedSoFar = Math.min(
                      m * (cfg.monthlyTopup || 0),
                      yearlyAdded
                    );
                    const base = startPrincipal + addedSoFar;
                    const monInterest = base * monthlyRate;
                    interestAcc += monInterest;
                    balance += monInterest;
                  }
                }
                interest = interestAcc;
              }

              const endBalance = startPrincipal + yearlyAdded + interest;
              cumulativeInterest += interest;

              rows.push({
                year: y,
                startPrincipal: round2(startPrincipal),
                added: round2(yearlyAdded),
                interest: round2(interest),
                endBalance: round2(endBalance),
                cumulativeInterest: round2(cumulativeInterest),
              });

              // critical: next year's start = this endBalance
              startPrincipal = endBalance;
            }

            const labels = rows.map((r) => r.year + " å¹´");
            const principalSeries = rows.map((r) => r.startPrincipal);
            const interestSeries = rows.map((r) => r.cumulativeInterest);
            const endSeries = rows.map((r) => r.endBalance);
            return {
              rows,
              labels,
              principalSeries,
              interestSeries,
              endSeries,
              finalBalance: rows.length ? rows[rows.length - 1].endBalance : 0,
            };
          }

          function round2(v) {
            return Math.round((v + Number.EPSILON) * 100) / 100;
          }

          function computeTimeline(profile) {
            const durationYears =
              profile.durationUnit === "year"
                ? Math.round(profile.duration)
                : Math.ceil(profile.duration / 12);
            const cfg = {
              initial: Number(profile.initial) || 0,
              monthlyTopup: Number(profile.monthlyTopup) || 0,
              annualRate:
                profile.returnRateUnit === "yearly"
                  ? (Number(profile.returnRate) || 0) / 100
                  : Math.pow(1 + (Number(profile.returnRate) || 0) / 100, 12) -
                    1,
              durationYears,
              compounding:
                profile.compounding === "monthly" ? "monthly" : "annually",
              interestBasis: interestBasis.value || "startPlusAdded",
            };
            return computeAnnualTimeline(cfg);
          }

          // safeClone
          function safeClone(obj) {
            try {
              return JSON.parse(JSON.stringify(obj));
            } catch (e) {
              if (Array.isArray(obj)) return obj.slice();
              if (obj && typeof obj === "object") return Object.assign({}, obj);
              return obj;
            }
          }

          // chart init/render
          function initChart() {
            try {
              const canvas = document.getElementById("chart");
              if (!canvas) return;
              canvas.width = canvas.clientWidth || canvas.width;
              canvas.height = canvas.clientHeight || canvas.height;
              if (chartInstance.value) {
                try {
                  chartInstance.value.destroy();
                } catch (e) {}
                chartInstance.value = null;
              }
              const ctx = canvas.getContext("2d");
              chartInstance.value = new Chart(ctx, {
                type: "line",
                data: { labels: [], datasets: [] },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  interaction: { mode: "index", intersect: false },
                  plugins: { legend: { position: "top" } },
                  scales: {
                    x: { display: true },
                    y: { display: true, beginAtZero: true },
                  },
                },
              });
            } catch (e) {
              console.warn("initChart", e);
            }
          }

          function renderChart(datasets, labels) {
            try {
              const safeDatasets = safeClone(datasets || []);
              const safeLabels = safeClone(labels || []);
              if (!chartInstance.value) initChart();
              if (!chartInstance.value) {
                console.error("æ— æ³•åˆ›å»º chart å®ä¾‹");
                return;
              }
              const colorPool = [
                "rgba(34,197,94,0.95)",
                "rgba(249,115,22,0.95)",
                "rgba(59,130,246,0.95)",
                "rgba(16,185,129,0.9)",
              ];
              chartInstance.value.data.labels = Array.isArray(safeLabels)
                ? safeLabels.slice()
                : [];
              chartInstance.value.data.datasets = safeDatasets.map(
                (ds, idx) => ({
                  label: String(ds.label || "series" + idx),
                  data: Array.isArray(ds.data) ? ds.data.slice() : [],
                  tension: 0.25,
                  fill: false,
                  borderWidth: 2,
                  borderColor: colorPool[idx % colorPool.length],
                  backgroundColor: colorPool[idx % colorPool.length].replace(
                    "0.95",
                    "0.2"
                  ),
                })
              );
              try {
                chartInstance.value.update();
              } catch (e) {
                console.error("chart update error", e);
              }
              lastRender = {
                mode: "single",
                datasets: safeClone(safeDatasets),
                labels: safeClone(safeLabels),
              };
            } catch (e) {
              console.error("renderChart failed", e);
            }
          }

          function onCalculate() {
            if (!activeProfileId.value) {
              alert("è¯·å…ˆé€‰æ‹©æˆ–æ–°å»ºæ¡£æ¡ˆ");
              return;
            }
            try {
              const p = storage.profiles.find(
                (x) => x.id === activeProfileId.value
              );
              const profileForCalc = p ? safeClone(p) : safeClone(form);
              const res = computeTimeline(profileForCalc);
              timeline.rows.splice(0, timeline.rows.length, ...res.rows);
              if (p) {
                [
                  "initial",
                  "monthlyTopup",
                  "returnRate",
                  "returnRateUnit",
                  "duration",
                  "durationUnit",
                  "compounding",
                ].forEach((k) => (p[k] = form[k]));
              }
              const datasets = [
                { label: "å¹´åˆæœ¬é‡‘", data: res.principalSeries },
                { label: "ç´¯è®¡åˆ©æ¯", data: res.interestSeries },
                { label: "å¹´æœ«ç´¯è®¡æ€»é¢", data: res.endSeries },
              ];
              renderChart(datasets, res.labels);
              if (collapsed.value) {
                collapsed.value = false;
                nextTick(() => {
                  try {
                    if (chartInstance.value) {
                      chartInstance.value.resize();
                      chartInstance.value.update();
                    }
                  } catch (e) {}
                });
              }
            } catch (e) {
              console.error("calculate error", e);
              alert("è®¡ç®—å¤±è´¥:" + (e && e.message ? e.message : e));
            }
          }

          function toggleStack() {
            stacked.value = !stacked.value;
            if (activeProfileId.value) onCalculate();
          }
          function downloadPNG() {
            try {
              const a = document.createElement("a");
              a.href = document.getElementById("chart").toDataURL("image/png");
              a.download = "compound_chart.png";
              a.click();
            } catch (e) {
              alert("ä¸‹è½½å¤±è´¥:" + e.message);
            }
          }

          function calculateComparison() {
            if (compareSelection.value.length === 0) {
              alert("è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæ¡£æ¡ˆ");
              return;
            }
            try {
              const datasets = [];
              let labels = null;
              compareSelection.value.forEach((id) => {
                const p = storage.profiles.find((x) => x.id === id);
                if (!p) return;
                const res = computeTimeline(p);
                if (!labels || res.labels.length > labels.length)
                  labels = res.labels;
                datasets.push({
                  label: p.name + " - å¹´åˆæœ¬é‡‘",
                  data: res.principalSeries,
                });
                datasets.push({
                  label: p.name + " - ç´¯è®¡åˆ©æ¯",
                  data: res.interestSeries,
                });
                datasets.push({
                  label: p.name + " - å¹´æœ«ç´¯è®¡",
                  data: res.endSeries,
                });
              });
              labels = labels || [];
              const L = labels.length;
              datasets.forEach((ds) => {
                if (!Array.isArray(ds.data)) ds.data = [];
                if (ds.data.length < L) {
                  const last = ds.data[ds.data.length - 1] || 0;
                  while (ds.data.length < L) ds.data.push(last);
                }
              });
              renderChart(datasets, labels);
              lastRender = {
                mode: "compare",
                datasets: safeClone(datasets),
                labels: safeClone(labels),
              };
              let summ = "æ¯”è¾ƒæ‘˜è¦:";
              datasets.forEach((ds) => {
                const last = ds.data[ds.data.length - 1] || 0;
                summ += `${ds.label}: ${formatCurrency(last)}`;
              });
              comparisonSummary.value = summ;
              timeline.rows.splice(0, timeline.rows.length);
            } catch (e) {
              console.error("calculateComparison", e);
              alert("æ¯”è¾ƒå¤±è´¥:" + (e && e.message ? e.message : e));
            }
          }

          function showComparisonSummary() {
            if (!comparisonSummary.value) alert("æš‚æ— æ¯”è¾ƒæ‘˜è¦");
            else alert(comparisonSummary.value);
          }

          function reloadRender() {
            try {
              if (chartInstance.value) {
                try {
                  chartInstance.value.destroy();
                } catch (e) {}
                chartInstance.value = null;
              }
              initChart();
              if (
                lastRender &&
                lastRender.datasets &&
                lastRender.datasets.length
              ) {
                renderChart(lastRender.datasets, lastRender.labels);
              } else if (activeProfileId.value) {
                onCalculate();
              } else {
                console.log("æ— å¯æ¸²æŸ“æ•°æ®");
              }
            } catch (e) {
              console.error("reloadRender", e);
              alert("é‡æ–°æ¸²æŸ“å¤±è´¥");
            }
          }

          // Service Worker: only on https or localhost
          function tryRegisterSW() {
            try {
              if ("serviceWorker" in navigator) {
                const isLocal =
                  location.protocol === "http:" &&
                  (location.hostname === "localhost" ||
                    location.hostname === "127.0.0.1");
                const isSecure = location.protocol === "https:";
                if (isSecure || isLocal) {
                  const swCode = `self.addEventListener('install',e=>{self.skipWaiting();});self.addEventListener('fetch',e=>{});`;
                  const blob = new Blob([swCode], {
                    type: "application/javascript",
                  });
                  const swUrl = URL.createObjectURL(blob);
                  navigator.serviceWorker
                    .register(swUrl)
                    .then(() => console.log("SW registered"))
                    .catch((err) => console.warn("SW register failed", err));
                } else {
                  console.log("é https/localhostï¼Œè·³è¿‡ Service Worker");
                }
              }
            } catch (e) {
              console.warn("sw register err", e);
            }
          }

          return {
            storage,
            form,
            profileNameInput,
            activeProfileId,
            createProfile,
            onProfileSelect,
            saveProfile,
            duplicateProfile,
            renameCurrent,
            deleteCurrent,
            resetForm,
            exportToFile,
            onImportFile,
            formatCurrency,
            onCalculate,
            toggleStack,
            downloadPNG,
            compareSelection,
            calculateComparison,
            comparisonSummary,
            showComparisonSummary,
            reloadRender,
            timeline,
            collapsed,
            interestBasis,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
