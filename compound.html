<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¤åˆ©è®¡ç®—å™¨ v6 (Mobile First, Offline-ready)</title>
  <link rel="manifest" href="manifest.json" />
  <!-- Vue 3 -->
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
  <!-- Chart.js (3.x ç³»åˆ—ï¼Œå…¼å®¹ chartjs-plugin-zoom v1.x) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <!-- Chart.js Zoom & Pan plugin (ç”¨äºæ‰‹åŠ¨ç¼©æ”¾/å¹³ç§») -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>

  <style>
    body { font-family: sans-serif; margin: 10px; background: #f9f9f9; }
    .card { background: white; border-radius: 10px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 10px; }
    .input-row { display: flex; flex-direction: column; margin-bottom: 8px; }
    label { font-size: 0.9em; color: #333; margin-bottom: 2px; }
    input, select { font-size: 1em; padding: 6px; border: 1px solid #ccc; border-radius: 5px; }
    button { margin: 5px 3px; padding: 6px 12px; border: none; border-radius: 5px; background: #4CAF50; color: white; font-size: 0.9em; }
    button:hover { background: #45a049; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: right; font-size: 0.9em; }
    th { background: #eee; }
    .chart-container { position: relative; height: 50vh; min-height: 300px; }
    .controls-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .small { padding: 4px 8px; font-size: 0.85em; }
    /* ä¿æŒ UI åœ¨çª„å±ä¸‹ä¹Ÿå‹å¥½ */
    @media (max-width:420px){
      .controls-row { gap:6px; }
      button { padding:6px 8px; font-size:0.85em; }
    }
  </style>
</head>
<body>
  <div id="app">
    <h2>å¤åˆ©è®¡ç®—å™¨ ğŸ“ˆ (v6)</h2>

    <!-- æ¡£æ¡ˆç®¡ç†å¡ç‰‡ï¼ˆUI ä¸ä¹‹å‰ä¿æŒä¸€è‡´ï¼‰ -->
    <div class="card">
      <div class="input-row">
        <label>æ¡£æ¡ˆç®¡ç†</label>
        <select v-model="activeProfileName" @change="loadProfile">
          <option v-for="p in profiles" :value="p.name">{{p.name}}</option>
        </select>
        <div class="controls-row">
          <button @click="newProfile" class="small">æ–°å¢</button>
          <button @click="duplicateProfile" class="small">å¤åˆ¶</button>
          <button @click="renameProfile" class="small">é‡å‘½å</button>
          <button @click="deleteProfile" class="small">åˆ é™¤</button>
          <button @click="exportProfiles" class="small">å¯¼å‡º</button>
          <input type="file" @change="importProfiles" />
          <!-- æ–°å¢ï¼šæ‰‹åŠ¨ä¿å­˜æŒ‰é’®ï¼ˆæ¡£æ¡ˆåŒºï¼‰ -->
          <button @click="saveProfile" class="small" title="ä¿å­˜å½“å‰æ¡£æ¡ˆå‚æ•°">ğŸ’¾ ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- å‚æ•°è¾“å…¥å¡ç‰‡ -->
    <div class="card">
      <div class="input-row"><label>åˆå§‹èµ„é‡‘</label><input v-model.number="form.initial" type="number"></div>
      <div class="input-row"><label>æ¯æœˆè¿½åŠ </label><input v-model.number="form.monthlyTopup" type="number"></div>
      <div class="input-row"><label>è¿½åŠ æœŸé™(å¹´)</label><input v-model.number="form.topupYears" type="number" @input="syncDuration"></div>
      <div class="input-row"><label>æœŸé™(å¹´)</label><input v-model.number="form.duration" type="number"></div>
      <div class="input-row"><label>å‚è€ƒå¹´ä»½</label><input v-model.number="form.referenceYear" type="number"></div>
      <div class="input-row">
        <label>åˆ©ç‡ (%)</label>
        <input v-model.number="form.returnRate" type="number">
        <select v-model="form.returnRateUnit"><option value="yearly">å¹´åˆ©ç‡</option><option value="monthly">æœˆåˆ©ç‡</option></select>
      </div>
      <div class="input-row">
        <label>å¤åˆ©é¢‘ç‡</label>
        <select v-model="form.compounding"><option value="yearly">æ¯å¹´</option><option value="monthly">æ¯æœˆ</option></select>
      </div>
      <div class="input-row">
        <label>åˆ©æ¯è®¡ç®—åŸºå‡†</label>
        <select v-model="form.interestBase">
          <option value="start">æŒ‰å¹´åˆæœ¬é‡‘</option>
          <option value="startPlus">æŒ‰(å¹´åˆ+å½“å¹´æ–°å¢)</option>
        </select>
      </div>
      <div class="controls-row">
        <button @click="calculate">è®¡ç®—</button>
        <button @click="resetForm">é‡ç½®</button>
        <button @click="reloadChart">ğŸ” é‡æ–°æ¸²æŸ“</button>
        <!-- æ–°å¢ï¼šæ‰‹åŠ¨ä¿å­˜æŒ‰é’®ï¼ˆè®¡ç®—åŒºï¼‰ -->
        <button @click="saveProfile" class="small" title="ä¿å­˜å½“å‰æ¡£æ¡ˆå‚æ•°">ğŸ’¾ ä¿å­˜</button>
      </div>
    </div>

    <!-- å›¾è¡¨å¡ç‰‡ï¼šå¢åŠ ç¼©æ”¾æ§åˆ¶ -->
    <div class="card">
      <div class="controls-row">
        <button @click="toggleChart">{{showChart?'éšè—å›¾è¡¨':'æ˜¾ç¤ºå›¾è¡¨'}}</button>
        <button @click="resetZoom" class="small">ğŸ” é‡ç½®ç¼©æ”¾</button>
        <button @click="toggleZoomMode" class="small">{{ zoomEnabled ? 'ç¦ç”¨ç¼©æ”¾' : 'å¯ç”¨ç¼©æ”¾' }}</button>
      </div>
      <div v-show="showChart" class="chart-container">
        <canvas id="chart"></canvas>
      </div>
    </div>

    <!-- ç»“æœè¡¨æ ¼ -->
    <div class="card" v-if="tableData.length">
      <table>
        <thead>
          <tr><th>æœŸ</th><th>å¹´</th><th>å¹´åˆæœ¬é‡‘</th><th>å½“å¹´æ–°å¢æœ¬é‡‘</th><th>æœ¬é‡‘ç´¯è®¡</th><th>å½“å¹´åˆ©æ¯</th><th>å¹´æœ«ç´¯è®¡æ€»é¢</th></tr>
        </thead>
        <tbody>
          <tr v-for="(row,i) in tableData" :key="i">
            <td>{{i+1}}</td><td style="text-align:center">{{row.year}}</td>
            <td>{{row.start.toFixed(2)}}</td><td>{{row.added.toFixed(2)}}</td>
            <td>{{row.totalPrincipal.toFixed(2)}}</td>
            <td>{{row.interest.toFixed(2)}}</td><td>{{row.end.toFixed(2)}}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // æœ¬åœ°å­˜å‚¨é”®
    const STORAGE_KEY = "compound_profiles";

    // æ³¨å†Œ zoom æ’ä»¶ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if (window.Chart && window.chartjsPluginZoom) {
      Chart.register(window.chartjsPluginZoom);
    }

    const app = Vue.createApp({
      data() {
        return {
          profiles: [],
          activeProfileName: "",
          // ç¡®ä¿åŒ…å«æ‰€æœ‰å­—æ®µï¼Œä»¥ä¾¿æ­£ç¡®ä¿å­˜/æ¢å¤
          form: {
            initial:0,
            monthlyTopup:0,
            topupYears:1,
            duration:1,
            referenceYear:new Date().getFullYear(),
            returnRate:5,
            returnRateUnit:"yearly",
            compounding:"yearly",
            interestBase:"start"
          },
          tableData: [],
          showChart: true,
          chart: null,
          zoomEnabled: true
        };
      },
      mounted() {
        this.loadProfiles();
      },
      methods: {
        // å½“ç”¨æˆ·æ”¹åŠ¨è¿½åŠ æœŸé™æ—¶ï¼Œå°è¯•åŒæ­¥æœŸé™ï¼ˆä¿ç•™åŸé€»è¾‘æ„å›¾ä½†æ›´ç¨³å¥ï¼‰
        syncDuration() {
          if (!this.form.duration || this.form.duration < 1) this.form.duration = Math.max(1, this.form.topupYears);
          // å¦‚æœç”¨æˆ·æŠŠtopupYearsè®¾ç½®å¤§äºdurationï¼Œæˆ‘ä»¬å¯ä»¥æŠŠdurationæ‰©å±•åˆ°topupYearsä»¥é¿å…ä¸¢å¤±è¿½åŠ 
          if (this.form.duration < this.form.topupYears) this.form.duration = this.form.topupYears;
        },

        // ä» localStorage è¯»å–æ¡£æ¡ˆï¼ˆå¹¶é»˜è®¤è½½å…¥ç¬¬ä¸€ä¸ªï¼‰
        loadProfiles() {
          try {
            const raw = localStorage.getItem(STORAGE_KEY) || '{"version":1,"profiles":[]}';
            const data = JSON.parse(raw);
            this.profiles = Array.isArray(data.profiles) ? data.profiles : [];
            if (this.profiles.length) {
              // å¦‚æœ activeProfileName ä»ä¸ºç©ºæˆ–æ‰¾ä¸åˆ°å¯¹åº”æ¡£æ¡ˆï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
              if (!this.activeProfileName || !this.profiles.find(p => p.name === this.activeProfileName)) {
                this.activeProfileName = this.profiles[0].name;
              }
              this.loadProfile();
            } else {
              // æ²¡æœ‰æ¡£æ¡ˆæ—¶ï¼Œåˆå§‹åŒ–ä¸€ä¸ªé»˜è®¤æ¡£æ¡ˆï¼ˆä½†ä¸å¼ºåˆ¶ä¿å­˜ï¼‰
              this.activeProfileName = "";
            }
          } catch (err) {
            console.error("åŠ è½½æ¡£æ¡ˆå¤±è´¥ï¼š", err);
            this.profiles = [];
            this.activeProfileName = "";
          }
        },

        // å°† profiles å†™å…¥ localStorageï¼ˆç»Ÿä¸€å…¥å£ï¼‰
        saveProfiles() {
          try {
            const payload = { version:1, profiles:this.profiles, lastUpdated:new Date().toISOString() };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
          } catch (err) {
            console.error("ä¿å­˜æ¡£æ¡ˆå¤±è´¥ï¼š", err);
            alert("ä¿å­˜æ¡£æ¡ˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å­˜å‚¨æƒé™ã€‚");
          }
        },

        // è½½å…¥é€‰å®šæ¡£æ¡ˆï¼šç¡®ä¿å®Œæ•´è¦†ç›– formï¼ˆé˜²æ­¢å­—æ®µç¼ºå¤±ï¼‰
        loadProfile() {
          const p = this.profiles.find(p=>p.name === this.activeProfileName);
          if (p) {
            // å¤åˆ¶æ‰€æœ‰å·²çŸ¥å­—æ®µï¼Œé˜²æ­¢å¼•ç”¨ç›¸äº’å½±å“
            const copy = {
              initial: p.initial ?? 0,
              monthlyTopup: p.monthlyTopup ?? 0,
              topupYears: p.topupYears ?? 1,
              duration: p.duration ?? 1,
              referenceYear: p.referenceYear ?? new Date().getFullYear(),
              returnRate: p.returnRate ?? 5,
              returnRateUnit: p.returnRateUnit ?? "yearly",
              compounding: p.compounding ?? "yearly",
              interestBase: p.interestBase ?? "start"
            };
            Object.assign(this.form, copy);
            // è½½å…¥åç«‹å³è®¡ç®—ï¼ˆä¿ç•™ v5 è¡Œä¸ºï¼‰
            this.calculate();
          } else {
            // æ²¡æœ‰æ‰¾åˆ°æ¡£æ¡ˆï¼Œåˆ™ä¿æŒå½“å‰è¡¨å•ä¸å˜
            console.warn("æœªæ‰¾åˆ°åä¸º", this.activeProfileName, "çš„æ¡£æ¡ˆ");
          }
        },

        // æ–°å¢æ¡£æ¡ˆï¼ˆä½¿ç”¨å½“å‰è¡¨å•å€¼ï¼‰
        newProfile() {
          const id = "p_" + Date.now();
          const nameBase = "Profile_" + (this.profiles.length + 1);
          let name = nameBase;
          // ç¡®ä¿åå­—å”¯ä¸€
          let i = 1;
          while (this.profiles.find(p => p.name === name)) { name = nameBase + "_" + (++i); }
          // ç¡®ä¿ä¿å­˜å®Œæ•´å­—æ®µåˆ°æ¡£æ¡ˆ
          const p = { id, name, ...this._formSnapshot() };
          this.profiles.push(p);
          this.activeProfileName = name;
          this.saveProfiles();
          alert("å·²æ–°å¢æ¡£æ¡ˆï¼š" + name);
        },

        // å¤åˆ¶å½“å‰æ¡£æ¡ˆ
        duplicateProfile() {
          const p0 = this.profiles.find(p => p.name === this.activeProfileName);
          if (!p0) { alert("å½“å‰æ²¡æœ‰é€‰ä¸­çš„æ¡£æ¡ˆå¯å¤åˆ¶ã€‚"); return; }
          const id = "p_" + Date.now();
          let newName = p0.name + "_copy";
          let i = 1;
          while (this.profiles.find(p => p.name === newName)) { newName = p0.name + "_copy" + (++i); }
          const copy = { ...p0, id, name: newName };
          this.profiles.push(copy);
          this.activeProfileName = newName;
          this.saveProfiles();
          alert("å·²å¤åˆ¶æ¡£æ¡ˆï¼š" + newName);
        },

        // é‡å‘½åæ¡£æ¡ˆ
        renameProfile() {
          const current = this.activeProfileName;
          if (!current) return alert("æ²¡æœ‰é€‰ä¸­çš„æ¡£æ¡ˆã€‚");
          const newName = prompt("è¾“å…¥æ–°æ¡£æ¡ˆå:", current);
          if (!newName) return;
          // é˜²æ­¢é‡å
          if (this.profiles.find(p => p.name === newName && p.name !== current)) {
            return alert("æ­¤åç§°å·²å­˜åœ¨ï¼Œè¯·é€‰æ‹©å…¶ä»–åç§°ã€‚");
          }
          const p = this.profiles.find(p => p.name === current);
          if (p) p.name = newName;
          this.activeProfileName = newName;
          this.saveProfiles();
        },

        // åˆ é™¤æ¡£æ¡ˆ
        deleteProfile() {
          if (!this.activeProfileName) return alert("æ²¡æœ‰é€‰ä¸­çš„æ¡£æ¡ˆã€‚");
          if (!confirm("ç¡®å®šåˆ é™¤å½“å‰æ¡£æ¡ˆ?")) return;
          this.profiles = this.profiles.filter(p => p.name !== this.activeProfileName);
          if (this.profiles.length) {
            this.activeProfileName = this.profiles[0].name;
            this.loadProfile();
          } else {
            this.activeProfileName = "";
            // é‡ç½®è¡¨å•ä½†ä¸è‡ªåŠ¨ä¿å­˜
            this.resetForm();
          }
          this.saveProfiles();
        },

        // å¯¼å‡ºæ¡£æ¡ˆ JSON
        exportProfiles() {
          const blob = new Blob([JSON.stringify({version:1,profiles:this.profiles,lastUpdated:new Date().toISOString()}, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "profiles_" + new Date().toISOString().replace(/[:T]/g,"_").slice(0,19) + ".json";
          a.click();
          URL.revokeObjectURL(url);
        },

        // å¯¼å…¥æ¡£æ¡ˆ JSONï¼ˆè¦†ç›– profilesï¼‰
        importProfiles(e) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (evt) => {
            try {
              const data = JSON.parse(evt.target.result);
              if (data.profiles && Array.isArray(data.profiles)) {
                this.profiles = data.profiles.map(p => {
                  // ç¡®ä¿æ¯ä¸ªæ¡£æ¡ˆéƒ½æœ‰å¿…éœ€å­—æ®µï¼ˆå‘åå…¼å®¹ï¼‰
                  return {
                    id: p.id ?? ("p_" + Date.now() + "_" + Math.floor(Math.random()*1000)),
                    name: p.name ?? ("Profile_imported_" + Math.floor(Math.random()*1000)),
                    initial: p.initial ?? 0,
                    monthlyTopup: p.monthlyTopup ?? 0,
                    topupYears: p.topupYears ?? 1,
                    duration: p.duration ?? 1,
                    referenceYear: p.referenceYear ?? new Date().getFullYear(),
                    returnRate: p.returnRate ?? 5,
                    returnRateUnit: p.returnRateUnit ?? "yearly",
                    compounding: p.compounding ?? "yearly",
                    interestBase: p.interestBase ?? "start"
                  };
                });
                this.saveProfiles();
                alert("å¯¼å…¥æˆåŠŸ");
                // è½½å…¥ç¬¬ä¸€ä¸ª
                if (this.profiles.length) {
                  this.activeProfileName = this.profiles[0].name;
                  this.loadProfile();
                }
              } else {
                throw new Error("JSON ä¸­ç¼ºå°‘ profiles å­—æ®µã€‚");
              }
            } catch (err) {
              console.error(err);
              alert("å¯¼å…¥å¤±è´¥: " + err.message);
            }
          };
          reader.readAsText(file);
          // æ¸…ç©º input ä»¥ä¾¿ä¸‹æ¬¡å¯¼å…¥åŒä¸€æ–‡ä»¶ä¹Ÿèƒ½è§¦å‘ change
          e.target.value = "";
        },

        // è®¡ç®—å¹´åº¦æ—¶é—´è½´ï¼ˆæ ¸å¿ƒè®¡ç®—é€»è¾‘ï¼‰
        computeAnnualTimeline() {
          const rows = [];
          let balance = Number(this.form.initial) || 0;
          let principalSum = Number(this.form.initial) || 0;
          // å¹´åŒ–ç‡è½¬æ¢ï¼ˆå¦‚æœå•ä½æ˜¯ monthlyï¼Œåˆ™å‡è®¾è¾“å…¥ä¸ºæœˆåˆ©ç‡ç™¾åˆ†æ¯”ï¼‰
          const rate = (this.form.returnRateUnit === "yearly")
            ? (Number(this.form.returnRate) || 0) / 100
            : ( (Number(this.form.returnRate) || 0) * 12 / 100 );

          for (let i = 1; i <= Number(this.form.duration); i++) {
            const added = i <= Number(this.form.topupYears) ? (Number(this.form.monthlyTopup) || 0) * 12 : 0;
            const base = (this.form.interestBase === "start") ? balance : (balance + added);

            // å¤åˆ©è®¡ç®—ï¼šæŒ‰å¹´æˆ–æŒ‰æœˆå¤åˆ©
            let interest = 0;
            if (this.form.compounding === "yearly") {
              interest = base * rate;
            } else {
              // æœˆå¤åˆ©ï¼šç”¨å¹´åŒ– rate è¿›è¡Œæ¢ç®—ï¼š (1 + rate/12)^12 - 1
              const monthlyRate = rate / 12;
              interest = base * (Math.pow(1 + monthlyRate, 12) - 1);
            }

            const end = balance + added + interest;
            principalSum += added;
            rows.push({
              year: Number(this.form.referenceYear) + i - 1,
              start: balance,
              added: added,
              interest: interest,
              end: end,
              totalPrincipal: principalSum
            });
            balance = end;
          }
          return rows;
        },

        // è®¡ç®—å¹¶æ¸²æŸ“å›¾è¡¨
        calculate() {
          try {
            // å…ˆæŠŠå½“å‰è¡¨å•å†™å›åˆ°å†…å­˜ä¸­çš„å½“å‰æ¡£æ¡ˆï¼ˆä½†ä¸è¦†ç›–æ¡£æ¡ˆé™¤éç”¨æˆ·æ‰‹åŠ¨ä¿å­˜ï¼‰
            // â€”â€” ä¿æŒç”¨æˆ·åœ¨åˆ‡æ¢æ¡£æ¡ˆå‰çš„ä¸´æ—¶ç¼–è¾‘ä¸ä¼šè¢«å¼ºåˆ¶å†™å…¥æ¡£æ¡ˆ
            this.tableData = this.computeAnnualTimeline();
            this.$nextTick(() => this.renderChart());
          } catch (err) {
            console.error("calculate failed", err);
            alert("è®¡ç®—å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥é¡¹ã€‚");
          }
        },

        // æ¸²æŸ“ Chart.js å›¾è¡¨ï¼ˆåŒ…å« auto-scaling ä¸ zoom é…ç½®ï¼‰
        renderChart() {
          try {
            const ctx = document.getElementById("chart").getContext("2d");
            if (this.chart) { try { this.chart.destroy(); } catch (e) { console.warn(e); } }

            const labels = this.tableData.map(r => String(r.year));
            const startData = this.tableData.map(r => r.start);
            const principalData = this.tableData.map(r => r.totalPrincipal);
            const interestData = this.tableData.map(r => r.interest);
            const endData = this.tableData.map(r => r.end);

            const pluginZoomAvailable = !!(window.chartjsPluginZoom && Chart && Chart.registry);

            const options = {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { mode: "index", intersect: false },
              scales: {
                x: {
                  ticks: { autoSkip: true, maxTicksLimit: 10 },
                },
                y: {
                  beginAtZero: true,
                  ticks: {
                    // ä½¿ç”¨æœ¬åœ°åŒ–æ ¼å¼æ˜¾ç¤ºæ•°å€¼
                    callback: function(value, index, ticks) {
                      return Number(value).toLocaleString();
                    }
                  }
                }
              },
              plugins: {
                legend: { position: 'top' },
                tooltip: {
                  mode: 'index',
                  callbacks: {
                    label: function(context) {
                      const val = context.parsed.y;
                      return context.dataset.label + ": " + (Number(val).toLocaleString(undefined, {maximumFractionDigits:2}));
                    }
                  }
                },
                // å¦‚æœæ’ä»¶å¯ç”¨ï¼Œåˆ™åŠ å…¥ zoom é…ç½®
                zoom: (pluginZoomAvailable ? {
                  zoom: {
                    wheel: { enabled: this.zoomEnabled },
                    pinch: { enabled: this.zoomEnabled },
                    mode: 'xy'
                  },
                  pan: {
                    enabled: this.zoomEnabled,
                    mode: 'xy'
                  }
                } : undefined)
              }
            };

            this.chart = new Chart(ctx, {
              type: "line",
              data: {
                labels,
                datasets: [
                  { label: "å¹´åˆæœ¬é‡‘", data: startData, borderColor: "orange", backgroundColor: "rgba(0,0,0,0)", fill: false, tension:0.1 },
                  { label: "æœ¬é‡‘ç´¯è®¡", data: principalData, borderColor: "brown", backgroundColor: "rgba(0,0,0,0)", fill: false, tension:0.1 },
                  { label: "åˆ©æ¯", data: interestData, borderColor: "green", backgroundColor: "rgba(0,0,0,0)", fill: false, tension:0.1 },
                  { label: "å¹´æœ«ç´¯è®¡æ€»é¢", data: endData, borderColor: "blue", backgroundColor: "rgba(0,0,0,0)", fill: false, tension:0.1 }
                ]
              },
              options
            });
          } catch (err) {
            console.error("renderChart failed:", err);
          }
        },

        // é‡æ–°æ¸²æŸ“å›¾è¡¨ï¼ˆä¿ç•™æ•°æ®ï¼‰
        reloadChart() {
          this.renderChart();
        },

        // æ‰‹åŠ¨ä¿å­˜å½“å‰æ¡£æ¡ˆï¼ˆä¸¤ä¸ªä¿å­˜æŒ‰é’®å…±ç”¨ï¼‰
        saveProfile() {
          // å¦‚æœæ²¡æœ‰æ´»åŠ¨æ¡£æ¡ˆï¼Œåˆ™æç¤ºæ˜¯å¦åˆ›å»ºæ–°æ¡£æ¡ˆå¹¶ä¿å­˜
          if (!this.activeProfileName) {
            if (!confirm("å½“å‰æ²¡æœ‰é€‰ä¸­çš„æ¡£æ¡ˆï¼Œè¦ä»¥å½“å‰å‚æ•°åˆ›å»ºæ–°æ¡£æ¡ˆå¹¶ä¿å­˜å—ï¼Ÿ")) return;
            // åˆ›å»ºæ–°æ¡£æ¡ˆ
            const id = "p_" + Date.now();
            const nameBase = "Profile_" + (this.profiles.length + 1);
            let name = nameBase;
            let i = 1;
            while (this.profiles.find(p => p.name === name)) { name = nameBase + "_" + (++i); }
            const p = { id, name, ...this._formSnapshot() };
            this.profiles.push(p);
            this.activeProfileName = name;
            this.saveProfiles();
            alert("å·²åˆ›å»ºå¹¶ä¿å­˜æ¡£æ¡ˆï¼š" + name);
            return;
          }
          // æ‰¾åˆ°æ¡£æ¡ˆå¹¶æ›´æ–°å…¨éƒ¨å­—æ®µ
          const p = this.profiles.find(p => p.name === this.activeProfileName);
          if (!p) {
            // è‹¥æ‰¾ä¸åˆ°ï¼ˆç†è®ºä¸Šä¸åº”å‘ç”Ÿï¼‰ï¼Œåˆ™æ–°å»º
            const id = "p_" + Date.now();
            const newP = { id, name: this.activeProfileName, ...this._formSnapshot() };
            this.profiles.push(newP);
            this.saveProfiles();
            alert("å·²ä¿å­˜æ¡£æ¡ˆï¼š" + this.activeProfileName);
            return;
          }
          // ç¡®ä¿æŠŠè¡¨å•æ‰€æœ‰å­—æ®µå†™å›æ¡£æ¡ˆï¼ˆä¿®å¤ topupYears/referenceYear æœªä¿å­˜çš„é—®é¢˜ï¼‰
          Object.assign(p, this._formSnapshot());
          this.saveProfiles();
          alert("å½“å‰æ¡£æ¡ˆå·²ä¿å­˜ âœ…");
        },

        // ç”Ÿæˆå½“å‰è¡¨å•çš„å¿«ç…§å¯¹è±¡ï¼ˆç”¨äºä¿å­˜/å¤åˆ¶/å¯¼å‡ºï¼‰
        _formSnapshot() {
          return {
            initial: Number(this.form.initial) || 0,
            monthlyTopup: Number(this.form.monthlyTopup) || 0,
            topupYears: Number(this.form.topupYears) || 1,
            duration: Number(this.form.duration) || 1,
            referenceYear: Number(this.form.referenceYear) || new Date().getFullYear(),
            returnRate: Number(this.form.returnRate) || 0,
            returnRateUnit: this.form.returnRateUnit || "yearly",
            compounding: this.form.compounding || "yearly",
            interestBase: this.form.interestBase || "start"
          };
        },

        // é‡ç½®è¡¨å•ï¼ˆä¸å½±å“å·²ä¿å­˜æ¡£æ¡ˆï¼‰
        resetForm() {
          Object.assign(this.form, {
            initial:0, monthlyTopup:0, topupYears:1, duration:1,
            referenceYear: new Date().getFullYear(), returnRate:5, returnRateUnit:"yearly",
            compounding:"yearly", interestBase:"start"
          });
          this.tableData = [];
          if (this.chart) {
            try { this.chart.destroy(); } catch(e) { console.warn(e); }
            this.chart = null;
          }
        },

        // å›¾è¡¨ç¼©æ”¾æ§åˆ¶ï¼šé‡ç½®ç¼©æ”¾
        resetZoom() {
          if (this.chart && this.chart.resetZoom) {
            try { this.chart.resetZoom(); }
            catch (e) { console.warn("resetZoom fail:", e); }
          } else {
            // å¦‚æœæ’ä»¶ä¸å¯ç”¨ï¼Œåˆ™é‡æ–°æ¸²æŸ“å›¾è¡¨ä½œä¸ºé€€è·¯
            this.renderChart();
          }
        },

        // å¯ç”¨/ç¦ç”¨ç¼©æ”¾å’Œå¹³ç§»
        toggleZoomMode() {
          this.zoomEnabled = !this.zoomEnabled;
          if (this.chart && this.chart.options && this.chart.options.plugins && this.chart.options.plugins.zoom) {
            this.chart.options.plugins.zoom.zoom.wheel.enabled = this.zoomEnabled;
            this.chart.options.plugins.zoom.zoom.pinch.enabled = this.zoomEnabled;
            this.chart.options.plugins.zoom.pan.enabled = this.zoomEnabled;
            this.chart.update();
          } else {
            // å¦‚æœå°šæœªæ¸²æŸ“æˆ– plugin ä¸å­˜åœ¨ï¼Œé‡æ–°æ¸²æŸ“ä¸€æ¬¡ä»¥ç¡®ä¿é…ç½®ç”Ÿæ•ˆ
            this.renderChart();
          }
        }
      }
    });

    app.mount("#app");
  </script>
</body>
</html>
