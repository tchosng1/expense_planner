<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¤åˆ©è®¡ç®—å™¨ (Mobile First, Offline)</title>
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 10px; background: #f9f9f9; }
    .card { background: white; border-radius: 10px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 10px; }
    .input-row { display: flex; flex-direction: column; margin-bottom: 8px; }
    label { font-size: 0.9em; color: #333; margin-bottom: 2px; }
    input, select { font-size: 1em; padding: 6px; border: 1px solid #ccc; border-radius: 5px; }
    button { margin: 5px 3px; padding: 6px 12px; border: none; border-radius: 5px; background: #4CAF50; color: white; font-size: 0.9em; }
    button:hover { background: #45a049; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: right; font-size: 0.9em; }
    th { background: #eee; }
    .chart-container { position: relative; height: 300px; }
  </style>
</head>
<body>
  <div id="app">
    <h2>å¤åˆ©è®¡ç®—å™¨ ğŸ“ˆ</h2>
    <div class="card">
      <div class="input-row">
        <label>æ¡£æ¡ˆç®¡ç†</label>
        <select v-model="activeProfileName" @change="loadProfile">
          <option v-for="p in profiles" :value="p.name">{{p.name}}</option>
        </select>
        <div>
          <button @click="newProfile">æ–°å¢</button>
          <button @click="duplicateProfile">å¤åˆ¶</button>
          <button @click="renameProfile">é‡å‘½å</button>
          <button @click="deleteProfile">åˆ é™¤</button>
          <button @click="exportProfiles">å¯¼å‡º</button>
          <input type="file" @change="importProfiles" />
        </div>
      </div>
    </div>

    <div class="card">
      <div class="input-row"><label>åˆå§‹èµ„é‡‘</label><input v-model.number="form.initial" type="number"></div>
      <div class="input-row"><label>æ¯æœˆè¿½åŠ </label><input v-model.number="form.monthlyTopup" type="number"></div>
      <div class="input-row"><label>è¿½åŠ æœŸé™(å¹´)</label><input v-model.number="form.topupYears" type="number" @input="syncDuration"></div>
      <div class="input-row"><label>æœŸé™(å¹´)</label><input v-model.number="form.duration" type="number"></div>
      <div class="input-row"><label>å‚è€ƒå¹´ä»½</label><input v-model.number="form.referenceYear" type="number"></div>
      <div class="input-row">
        <label>åˆ©ç‡ (%)</label>
        <input v-model.number="form.returnRate" type="number">
        <select v-model="form.returnRateUnit"><option value="yearly">å¹´åˆ©ç‡</option><option value="monthly">æœˆåˆ©ç‡</option></select>
      </div>
      <div class="input-row">
        <label>å¤åˆ©é¢‘ç‡</label>
        <select v-model="form.compounding"><option value="yearly">æ¯å¹´</option><option value="monthly">æ¯æœˆ</option></select>
      </div>
      <div class="input-row">
        <label>åˆ©æ¯è®¡ç®—åŸºå‡†</label>
        <select v-model="form.interestBase">
          <option value="start">æŒ‰å¹´åˆæœ¬é‡‘</option>
          <option value="startPlus">æŒ‰(å¹´åˆ+å½“å¹´æ–°å¢)</option>
        </select>
      </div>
      <div>
        <button @click="calculate">è®¡ç®—</button>
        <button @click="resetForm">é‡ç½®</button>
        <button @click="reloadChart">ğŸ” é‡æ–°æ¸²æŸ“</button>
      </div>
    </div>

    <div class="card">
      <button @click="toggleChart">{{showChart?'éšè—å›¾è¡¨':'æ˜¾ç¤ºå›¾è¡¨'}}</button>
      <div v-show="showChart" class="chart-container">
        <canvas id="chart"></canvas>
      </div>
    </div>

    <div class="card" v-if="tableData.length">
      <table>
        <thead>
          <tr><th>æœŸ</th><th>å¹´</th><th>å¹´åˆæœ¬é‡‘</th><th>å½“å¹´æ–°å¢æœ¬é‡‘</th><th>æœ¬é‡‘ç´¯è®¡</th><th>å½“å¹´åˆ©æ¯</th><th>å¹´æœ«ç´¯è®¡æ€»é¢</th></tr>
        </thead>
        <tbody>
          <tr v-for="(row,i) in tableData" :key="i">
            <td>{{i+1}}</td><td>{{row.year}}</td>
            <td>{{row.start.toFixed(2)}}</td><td>{{row.added.toFixed(2)}}</td>
            <td>{{row.totalPrincipal.toFixed(2)}}</td>
            <td>{{row.interest.toFixed(2)}}</td><td>{{row.end.toFixed(2)}}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "compound_profiles";

    const app = Vue.createApp({
      data() {
        return {
          profiles: [],
          activeProfileName: "",
          form: { initial:0, monthlyTopup:0, topupYears:1, duration:1, referenceYear:2025, returnRate:5, returnRateUnit:"yearly", compounding:"yearly", interestBase:"start" },
          tableData: [], showChart: true, chart:null
        };
      },
      mounted() { this.loadProfiles(); },
      methods: {
        syncDuration() { if(this.form.duration===0||this.form.duration===this.form.topupYears-1) this.form.duration=this.form.topupYears; },
        loadProfiles() {
          const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{"version":1,"profiles":[]}' );
          this.profiles = data.profiles || [];
          if (this.profiles.length) { this.activeProfileName = this.profiles[0].name; this.loadProfile(); }
        },
        saveProfiles() { localStorage.setItem(STORAGE_KEY, JSON.stringify({version:1, profiles:this.profiles, lastUpdated:new Date().toISOString()})); },
        loadProfile() {
          const p = this.profiles.find(p=>p.name===this.activeProfileName);
          if (p) Object.assign(this.form, p);
          this.calculate();
        },
        newProfile() {
          const id="p_"+Date.now(), name="Profile_"+(this.profiles.length+1);
          this.profiles.push({...this.form,id,name}); this.activeProfileName=name; this.saveProfiles();
        },
        duplicateProfile() {
          const p=this.profiles.find(p=>p.name===this.activeProfileName); if(!p) return;
          const newName=p.name+"_copy"; this.profiles.push({...p,name:newName,id:"p_"+Date.now()}); this.activeProfileName=newName; this.saveProfiles();
        },
        renameProfile() {
          const newName=prompt("è¾“å…¥æ–°æ¡£æ¡ˆå:",this.activeProfileName); if(!newName)return;
          const p=this.profiles.find(p=>p.name===this.activeProfileName); if(p)p.name=newName; this.activeProfileName=newName; this.saveProfiles();
        },
        deleteProfile() {
          if(!confirm("ç¡®å®šåˆ é™¤å½“å‰æ¡£æ¡ˆ?"))return;
          this.profiles=this.profiles.filter(p=>p.name!==this.activeProfileName); if(this.profiles.length)this.activeProfileName=this.profiles[0].name; this.saveProfiles();
        },
        exportProfiles() {
          const blob=new Blob([JSON.stringify({version:1,profiles:this.profiles,lastUpdated:new Date().toISOString()},null,2)],{type:"application/json"});
          const url=URL.createObjectURL(blob); const a=document.createElement("a");
          a.href=url; a.download="profiles_"+new Date().toISOString().replace(/[:T]/g,"_").slice(0,19)+".json"; a.click(); URL.revokeObjectURL(url);
        },
        importProfiles(e) {
          const file=e.target.files[0]; if(!file)return;
          const reader=new FileReader(); reader.onload=(evt)=>{
            try{ const data=JSON.parse(evt.target.result); if(data.profiles)this.profiles=data.profiles; this.saveProfiles(); alert("å¯¼å…¥æˆåŠŸ"); }
            catch(err){alert("å¯¼å…¥å¤±è´¥:"+err);} };
          reader.readAsText(file);
        },
        computeAnnualTimeline() {
          const rows=[];
          let balance=this.form.initial, principalSum=this.form.initial;
          const rate=this.form.returnRateUnit==="yearly"?this.form.returnRate/100:this.form.returnRate*12/100;
          for(let i=1;i<=this.form.duration;i++){
            const added=i<=this.form.topupYears?this.form.monthlyTopup*12:0;
            const base=this.form.interestBase==="start"?balance:(balance+added);
            const interest=this.form.compounding==="yearly"?base*rate:(base*((Math.pow(1+rate/12,12))-1));
            const end=balance+added+interest;
            principalSum+=added;
            rows.push({year:this.form.referenceYear+i-1,start:balance,added,interest,end,totalPrincipal:principalSum});
            balance=end;
          }
          return rows;
        },
        calculate() {
          try {
            this.tableData=this.computeAnnualTimeline();
            this.$nextTick(()=>this.renderChart());
          } catch(err){console.error("calculate failed",err);}
        },
        renderChart() {
          try {
            const ctx=document.getElementById("chart").getContext("2d");
            if(this.chart){this.chart.destroy();}
            const labels=this.tableData.map(r=>r.year);
            const startData=this.tableData.map(r=>r.start);
            const principalData=this.tableData.map(r=>r.totalPrincipal);
            const interestData=this.tableData.map(r=>r.interest);
            const endData=this.tableData.map(r=>r.end);
            this.chart=new Chart(ctx,{type:"line",data:{labels,
              datasets:[
                {label:"å¹´åˆæœ¬é‡‘",data:startData,borderColor:"orange",fill:false},
                {label:"æœ¬é‡‘ç´¯è®¡",data:principalData,borderColor:"brown",fill:false},
                {label:"åˆ©æ¯",data:interestData,borderColor:"green",fill:false},
                {label:"å¹´æœ«ç´¯è®¡æ€»é¢",data:endData,borderColor:"blue",fill:false}
              ]},
              options:{responsive:true,interaction:{mode:"index"}}});
          } catch(err){console.error("renderChart failed (non-retry):",err);}
        },
        resetForm() { Object.assign(this.form,{initial:0,monthlyTopup:0,topupYears:1,duration:1,referenceYear:2025,returnRate:5,returnRateUnit:"yearly",compounding:"yearly",interestBase:"start"}); this.tableData=[]; if(this.chart){this.chart.destroy();} },
        reloadChart() { this.renderChart(); },
        toggleChart() { this.showChart=!this.showChart; if(this.showChart) this.$nextTick(()=>this.renderChart()); }
      }
    });
    app.mount("#app");
  </script>
</body>
</html>
