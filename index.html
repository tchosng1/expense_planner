<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>个人收入支出规划（本地 - V4）</title>

<!-- Vue 3 -->
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- ExcelJS (browser) -->
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
<!-- FileSaver for saving generated xlsx -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
:root{
  --primary:#1a4e89; --accent:#3a7bd5; --danger:#c0392b; --muted:#8b9ab3;
}
*{box-sizing:border-box}
body{ font-family:"Microsoft YaHei", Arial, sans-serif; background:#f4f7fb; margin:0; color:#222;}
header{ background: linear-gradient(90deg,var(--primary),var(--accent)); color:#fff; padding:12px 16px; text-align:center; font-size:18px; }
.container{ max-width:1100px; margin:18px auto; background:#fff; border-radius:10px; padding:14px; box-shadow:0 6px 18px rgba(20,30,60,0.06);}
h2{ color:var(--primary); margin:8px 0;}
table{ width:100%; border-collapse:collapse; margin-bottom:10px; font-size:13px; }
th, td{ border:1px solid #e6eef6; padding:6px; vertical-align:middle; }
th{ background:#eaf1f8; text-align:left; padding:8px; font-weight:700;}
.icon-btn{ background:transparent; border:0; padding:6px; cursor:pointer; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; }
.icon-btn svg{ width:18px; height:18px; stroke:#2c3e50; }
.icon-btn.danger svg{ stroke:var(--danger); }
.icon-btn.small{ padding:4px; }
.add-btn{ background:var(--accent); color:#fff; border-radius:6px; padding:6px 10px; cursor:pointer; border:0; }
.input-num{ width:110px; } /* narrow numeric input for ~6 digits */
.input-name{ width:220px; } /* truncated width for vertical fit */
.compact-name{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:220px; display:inline-block; vertical-align:middle; }
.controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
.col { flex:1; min-width:120px; }
.small-note{ font-size:12px; color:var(--muted); }
.chart-wrap{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
.chart-card{ flex:1 1 320px; background:#fafcff; padding:10px; border-radius:8px; border:1px solid #eef5ff; }
.meta{ font-size:13px; color:#666; }
.percent-total{ font-weight:700; }
.file-info{ font-size:12px; color:#666; margin-top:6px; }
.footer-actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px; }
.file-input{ display:none; }
</style>
</head>
<body>
<header>个人收入支出规划（离线可用 - V4，兼容旧数据）</header>

<div id="app" class="container">
  <div class="row" style="justify-content:space-between; align-items:center;">
    <h2>收入区</h2>
    <div>
      <button class="add-btn" @click="addIncome">＋ 添加收入</button>
      <button class="add-btn" style="background:#1a9b5b;margin-left:8px" @click="importJSON">📂 导入 JSON</button>
      <input id="fileImport" class="file-input" type="file" accept=".json" @change="onFileImport" />
    </div>
  </div>

  <table>
    <thead>
      <tr><th style="width:48%">项目名</th><th style="width:20%">金额 (RM)</th><th style="width:32%">操作</th></tr>
    </thead>
    <tbody>
      <tr v-for="(inc, i) in incomes" :key="'inc-'+i">
        <td>
          <input class="input-name" v-model="inc.name" :placeholder="'项目名称'" @blur="triggerSave" />
        </td>
        <td>
          <input class="input-num" type="number" min="0" step="1" v-model.number="inc.amount" @input="limitNumber(i,'income')" />
        </td>
        <td>
          <div style="display:flex; gap:6px; align-items:center;">
            <button class="icon-btn small" :title="'上移'" @click="moveIncomeUp(i)" :disabled="i===0" v-html="icons.arrowUp"></button>
            <button class="icon-btn small" :title="'下移'" @click="moveIncomeDown(i)" :disabled="i===incomes.length-1" v-html="icons.arrowDown"></button>
            <button class="icon-btn small danger" :title="'删除'" @click="removeIncome(i)" v-html="icons.trash"></button>
          </div>
        </td>
      </tr>
      <tr v-if="incomes.length===0"><td colspan="3" class="small-note" style="text-align:center">（当前无收入项）</td></tr>
      <tr>
        <th>收入总和</th>
        <td colspan="2">RM {{ totalIncome.toFixed(2) }}</td>
      </tr>
    </tbody>
  </table>

  <div class="row" style="justify-content:space-between; align-items:center; margin-top:6px;">
    <h2>支出区</h2>
    <div class="controls">
      <button class="add-btn" @click="addExpenseCategory">＋ 添加分类</button>
      <button class="add-btn" style="background:#ff8c42" @click="resetDefaultCategories">恢复默认</button>
      <div class="meta">总分配：<span :class="{'percent-total':true, 'warn': percentTotal!==100}" :style="{color: percentTotal===100? 'green' : (percentTotal>100? 'var(--danger)':'#c67')}">{{ percentTotal }}%</span></div>
    </div>
  </div>

  <table>
    <thead>
      <tr><th style="width:18%">分类</th><th style="width:12%">比例 (%)</th><th>细项（名称 / 金额 / 操作）</th><th style="width:18%">分类：支出 / 预算</th></tr>
    </thead>
    <tbody>
      <tr v-for="(cat, ci) in expenses" :key="'cat-'+ci">
        <td style="vertical-align:top;">
          <input class="input-name" v-model="cat.name" @blur="triggerSave" />
          <div style="margin-top:8px;">
            <button class="icon-btn small" :title="'上移分类'" @click="moveCategoryUp(ci)" :disabled="ci===0" v-html="icons.arrowUp"></button>
            <button class="icon-btn small" :title="'下移分类'" @click="moveCategoryDown(ci)" :disabled="ci===expenses.length-1" v-html="icons.arrowDown"></button>
            <button class="icon-btn small danger" :title="'删除分类'" @click="removeCategory(ci)" v-html="icons.trash"></button>
          </div>
        </td>
        <td>
          <input type="number" min="0" max="100" v-model.number="cat.percent" @input="triggerSave" />
        </td>
        <td>
          <table style="width:100%; border:0;">
            <tbody>
              <tr v-for="(it, ii) in cat.items" :key="ci+'-'+ii">
                <td style="width:55%"><input class="input-name" v-model="it.name" placeholder="细项名称" @blur="triggerSave" /></td>
                <td style="width:22%"><input class="input-num" type="number" min="0" step="1" v-model.number="it.amount" @input="limitNumber(ci, 'expense', ii)" /></td>
                <td style="width:23%">
                  <div style="display:flex; gap:6px; align-items:center;">
                    <button class="icon-btn small" :title="'上移细项'" @click="moveExpenseItemUp(ci, ii)" :disabled="ii===0" v-html="icons.arrowUp"></button>
                    <button class="icon-btn small" :title="'下移细项'" @click="moveExpenseItemDown(ci, ii)" :disabled="ii===cat.items.length-1" v-html="icons.arrowDown"></button>
                    <button class="icon-btn small danger" :title="'删除细项'" @click="removeExpenseItem(ci, ii)" v-html="icons.trash"></button>
                  </div>
                </td>
              </tr>
              <tr v-if="cat.items.length===0"><td colspan="3" class="small-note" style="text-align:center">（尚无细项）</td></tr>
              <tr>
                <td colspan="3"><button class="add-btn" @click="addExpenseItem(ci)">＋ 添加细项</button></td>
              </tr>
              <tr style="background:#fbfdff;">
                <td><strong>小计</strong></td>
                <td colspan="2">RM {{ categoryTotal(cat).toFixed(2) }} / 预算 RM {{ budgetAmount(cat).toFixed(2) }}</td>
              </tr>
            </tbody>
          </table>
        </td>
        <td style="vertical-align:top;">
          <div>已支出：RM {{ categoryTotal(cat).toFixed(2) }}</div>
          <div style="margin-top:8px">预算：RM {{ budgetAmount(cat).toFixed(2) }}</div>
        </td>
      </tr>
    </tbody>
    <tfoot>
      <tr style="background:#eef7ff;">
        <th>支出总计</th>
        <td colspan="3">RM {{ totalExpense.toFixed(2) }}</td>
      </tr>
      <tr>
        <th>结余</th>
        <td colspan="3" :style="{color:(totalIncome - totalExpense)>=0 ? 'green':'var(--danger)'}">
          {{ (totalIncome - totalExpense)>=0 ? '盈余' : '赤字' }}：RM {{ (totalIncome - totalExpense).toFixed(2) }}
        </td>
      </tr>
    </tfoot>
  </table>

  <div class="footer-actions">
    <button class="add-btn" @click="saveNow" title="保存到 localStorage">💾 保存</button>
    <button class="add-btn" style="background:#6b8" @click="exportExcel" title="导出为 Excel (.xlsx)">⬇️ 导出 Excel</button>
    <button class="add-btn" style="background:#7cc" @click="exportJSON" title="导出 JSON 备份">📤 导出 JSON</button>
    <button class="add-btn" style="background:#888" @click="showStorage" title="显示本地储存 (raw)">📁 显示储存</button>
    <button class="add-btn" style="background:var(--danger)" @click="clearAllConfirm">⚠️ 清空并恢复默认</button>
    <div style="flex:1"></div>
    <div class="file-info">
      自动保存：<strong>{{ autoSave ? '开启' : '关闭' }}</strong> · 最后保存：<strong>{{ lastSaved ? lastSaved : '—' }}</strong><br>
      Storage key: <code>{{ storageKey }}</code>
    </div>
  </div>

  <div class="chart-wrap">
    <div class="chart-card">
      <h3>收入分布</h3>
      <canvas id="incomeChart" width="400" height="260"></canvas>
    </div>
    <div class="chart-card">
      <h3>支出结构（分类）</h3>
      <canvas id="expenseChart" width="400" height="260"></canvas>
    </div>
  </div>
</div>

<script>
const { createApp } = Vue;

const ICONS = {
  plus: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>',
  trash: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>',
  arrowUp: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19V5"/><path d="M5 12l7-7 7 7"/></svg>',
  arrowDown: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M19 12l-7 7-7-7"/></svg>'
};

createApp({
  data(){
    return {
      // include multiple legacy keys for compatibility
      storageKey: 'local_finance_planner_v2',
      legacyKeys: ['local_finance_planner_v1','local_finance_planner','incomeExpenseData','plannerData','finance_backup'],
      autoSave: true,
      lastSaved: null,
      incomes: [
        {name:'工资', amount:5000},
        {name:'副业', amount:800}
      ],
      expenses: [
        { name:'投资', percent:25, items:[ {name:'股票', amount:0} ] },
        { name:'贷款', percent:36, items:[ {name:'房贷', amount:0} ] },
        { name:'承担', percent:25, items:[ {name:'父母/保险', amount:0} ] },
        { name:'生活费', percent:12, items:[ {name:'食物/交通', amount:0} ] },
        { name:'其它', percent:2, items:[ {name:'杂项', amount:0} ] }
      ],
      incomeChart:null,
      expenseChart:null,
      icons: ICONS
    }
  },
  computed:{
    totalIncome(){ return this.incomes.reduce((s,i)=> s + (Number(i.amount)||0), 0); },
    totalExpense(){ return this.expenses.reduce((s,c)=> s + this.categoryTotal(c), 0); },
    percentTotal(){ return Math.round(this.expenses.reduce((s,c)=> s + (Number(c.percent)||0), 0)); }
  },
  methods:{
    limitNumber(idxOrCat, type, subIdx){
      if(type === 'income'){
        this.incomes[idxOrCat].amount = Math.max(0, Math.min(999999, Number(this.incomes[idxOrCat].amount) || 0));
      } else if(type === 'expense'){
        this.expenses[idxOrCat].items[subIdx].amount = Math.max(0, Math.min(999999, Number(this.expenses[idxOrCat].items[subIdx].amount) || 0));
      }
      this.triggerSave();
    },
    addIncome(){ this.incomes.push({name:'', amount:0}); this.triggerSave(); },
    removeIncome(i){ if(confirm('删除该收入项？')){ this.incomes.splice(i,1); this.triggerSave(); } },
    moveIncomeUp(i){ if(i>0){ [this.incomes[i-1], this.incomes[i]] = [this.incomes[i], this.incomes[i-1]]; this.triggerSave(); } },
    moveIncomeDown(i){ if(i < this.incomes.length-1){ [this.incomes[i+1], this.incomes[i]] = [this.incomes[i], this.incomes[i+1]]; this.triggerSave(); } },

    addExpenseCategory(){ this.expenses.push({name:'新分类', percent:0, items:[{name:'细项', amount:0}]}); this.triggerSave(); },
    removeCategory(ci){ if(confirm('删除分类及其细项？')){ this.expenses.splice(ci,1); this.triggerSave(); } },
    moveCategoryUp(ci){ if(ci>0){ [this.expenses[ci-1], this.expenses[ci]] = [this.expenses[ci], this.expenses[ci-1]]; this.triggerSave(); } },
    moveCategoryDown(ci){ if(ci < this.expenses.length-1){ [this.expenses[ci+1], this.expenses[ci]] = [this.expenses[ci], this.expenses[ci+1]]; this.triggerSave(); } },
    resetDefaultCategories(){ if(confirm('恢复默认五个分类？会替换当前分类。')){ this.expenses = [
      { name:'投资', percent:25, items:[ {name:'股票', amount:0} ] },
      { name:'贷款', percent:36, items:[ {name:'房贷', amount:0} ] },
      { name:'承担', percent:25, items:[ {name:'父母/保险', amount:0} ] },
      { name:'生活费', percent:12, items:[ {name:'食物/交通', amount:0} ] },
      { name:'其它', percent:2, items:[ {name:'杂项', amount:0} ] }
    ]; this.triggerSave(); } },

    addExpenseItem(ci){ this.expenses[ci].items.push({name:'', amount:0}); this.triggerSave(); },
    removeExpenseItem(ci, ii){ if(confirm('删除该支出细项？')){ this.expenses[ci].items.splice(ii,1); this.triggerSave(); } },
    moveExpenseItemUp(ci, ii){ if(ii>0){ const arr = this.expenses[ci].items; [arr[ii-1], arr[ii]] = [arr[ii], arr[ii-1]]; this.triggerSave(); } },
    moveExpenseItemDown(ci, ii){ const arr = this.expenses[ci].items; if(ii < arr.length-1){ [arr[ii+1], arr[ii]] = [arr[ii], arr[ii+1]]; this.triggerSave(); } },

    categoryTotal(cat){ return (cat.items || []).reduce((s,it)=> s + (Number(it.amount)||0), 0); },
    budgetAmount(cat){ return this.totalIncome * (Number(cat.percent)||0) / 100; },

    triggerSave(){ if(this.autoSave) this.saveNow(); this.updateCharts(); },
    saveNow(){
      try{
        const payload = { version:4, incomes:this.incomes, expenses:this.expenses, savedAt: new Date().toISOString() };
        localStorage.setItem(this.storageKey, JSON.stringify(payload));
        this.lastSaved = new Date().toLocaleString();
      }catch(e){ console.error('save error', e); alert('保存失败：' + e.message); }
    },
    loadFromStorage(){
      try{
        // try primary key first
        const raw = localStorage.getItem(this.storageKey);
        if(raw){
          const p = JSON.parse(raw);
          // simple validation
          if(p && (p.incomes || p.expenses)){
            // if older version numbers, migrate if needed
            this.migrateAndLoad(p);
            return;
          }
        }
        // try legacy keys
        for(const k of this.legacyKeys){
          const rv = localStorage.getItem(k);
          if(rv){
            try{
              const parsed = JSON.parse(rv);
              if(parsed && (parsed.incomes || parsed.expenses)){
                // migrate and save into new key
                this.migrateAndLoad(parsed);
                this.saveNow();
                return;
              }
            }catch(e){ console.warn('parse legacy key failed', k, e); }
          }
        }
        // nothing found; keep defaults
      }catch(e){ console.error('load error', e); }
    },
    migrateAndLoad(parsed){
      // Handle various possible shapes
      // If parsed has version and is >=4, assume compatible
      if(parsed.version && parsed.version >= 4){
        this.incomes = parsed.incomes || this.incomes;
        this.expenses = parsed.expenses || this.expenses;
        this.lastSaved = parsed.savedAt ? new Date(parsed.savedAt).toLocaleString() : null;
        return;
      }
      // If older version or no version, attempt to map fields
      const incomes = parsed.incomes || parsed.incomeList || parsed.sources || [];
      const expenses = parsed.expenses || parsed.expenseList || parsed.outcomes || [];
      // Ensure structure: categories have name, percent, items[]
      const normExpenses = expenses.map(e=>{
        if(e.items) return e;
        if(e.subitems) return { name: e.name||'分类', percent: e.percent||0, items: e.subitems };
        if(e.name && e.amount !== undefined) return { name: e.name, percent: e.percent||0, items:[{name:e.name, amount:e.amount||0}] };
        return { name: e.name||'分类', percent: e.percent||0, items: e.items||[] };
      });
      this.incomes = incomes;
      this.expenses = normExpenses.length ? normExpenses : this.expenses;
      this.lastSaved = parsed.savedAt ? new Date(parsed.savedAt).toLocaleString() : null;
    },

    showStorage(){
      const raw = localStorage.getItem(this.storageKey) || '（无）';
      const w = window.open('', '_blank');
      w.document.title = '本地储存内容';
      w.document.body.innerHTML = '<pre>' + raw.replace(/</g,'&lt;') + '</pre>';
    },

        // import JSON (file input)
    importJSON(){
      document.getElementById('fileImport').value = null;
      document.getElementById('fileImport').click();
    },
    onFileImport(evt){
      const f = evt.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try{
          const parsed = JSON.parse(e.target.result);
          if(!parsed) throw new Error('JSON 无效');
          if(parsed.version && parsed.version >= 2){
            if(confirm('选择「确定」将用导入的数据替换当前并保存；按「取消」则合并到当前数据（保留现有项）。')){
              this.incomes = parsed.incomes || [];
              this.expenses = parsed.expenses || [];
            } else {
              this.incomes = this.incomes.concat(parsed.incomes || []);
              this.expenses = this.expenses.concat(parsed.expenses || []);
            }
            this.saveNow();
            this.updateCharts();
            alert('导入完成');
            return;
          }
          if(parsed.incomes || parsed.expenses){
            if(confirm('导入数据是否替换当前？选择「确定」替换，「取消」合并。')){
              this.incomes = parsed.incomes || [];
              this.expenses = parsed.expenses || [];
            } else {
              this.incomes = this.incomes.concat(parsed.incomes || []);
              this.expenses = this.expenses.concat(parsed.expenses || []);
            }
            this.saveNow();
            this.updateCharts();
            alert('导入完成（兼容旧结构）');
            return;
          }
          alert('无法识别的 JSON 格式');
        }catch(err){
          alert('导入失败：' + err.message);
        }
      };
      reader.readAsText(f);
    },

    exportJSON(){
      try{
        const payload = { version:4, incomes:this.incomes, expenses:this.expenses, savedAt:new Date().toISOString() };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
        const fname = `income_expense_backup_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
        saveAs(blob, fname);
      }catch(e){ alert('导出JSON失败：' + e.message); }
    },

    async exportExcel(){
      try{
        const wb = new ExcelJS.Workbook();
        const ws = wb.addWorksheet('收入支出规划');

        const title = `个人理财规划 by Hau Hau - ${new Date().toLocaleString()}`;
        ws.mergeCells('A1','F1');
        ws.getCell('A1').value = title;
        ws.getCell('A1').font = { size:14, bold:true };
        ws.getRow(1).height = 24;

        let r = 3;
        ws.getCell('A'+r).value = '收入区';
        ws.getCell('A'+r).font = { bold:true };
        r++;
        ws.getRow(r).values = ['项目', '金额 (RM)'];
        ws.getRow(r).eachCell(c => c.font = { bold:true });
        r++;

        const incStart = r;
        for(const inc of this.incomes){
          ws.getCell('A'+r).value = inc.name || '';
          ws.getCell('B'+r).value = Number(inc.amount) || 0;
          r++;
        }
        const incEnd = r-1;
        ws.getCell('A'+r).value = '收入总计';
        if(incEnd >= incStart){
          ws.getCell('B'+r).value = { formula: `SUM(B${incStart}:B${incEnd})` };
        } else {
          ws.getCell('B'+r).value = 0;
        }
        const incomeTotalCell = 'B'+r;
        ws.getCell(incomeTotalCell).numFmt = '0.00';
        r += 2;

        ws.getCell('A'+r).value = '支出区';
        ws.getCell('A'+r).font = { bold:true };
        r++;
        ws.getRow(r).values = ['分类','比例 (%)','细项','金额 (RM)','分类小计 (公式)','预算 (公式)'];
        ws.getRow(r).eachCell(c => c.font = { bold:true });
        r++;

        const subtotalCells = [];
        for(const cat of this.expenses){
          const catRowStart = r;
          ws.getCell('A'+r).value = cat.name || '';
          ws.getCell('B'+r).value = Number(cat.percent) || 0;
          if((cat.items||[]).length > 0){
            ws.getCell('C'+r).value = cat.items[0].name || '';
            ws.getCell('D'+r).value = Number(cat.items[0].amount) || 0;
            r++;
            for(let i=1;i<cat.items.length;i++){
              ws.getCell('C'+r).value = cat.items[i].name || '';
              ws.getCell('D'+r).value = Number(cat.items[i].amount) || 0;
              r++;
            }
          } else {
              ws.getCell('C'+r).value = '';
              ws.getCell('D'+r).value = 0;
              r++;
          }
          const catRowEnd = r-1;
          ws.getCell('E'+r).value = { formula: `SUM(D${catRowStart}:D${catRowEnd})` };
          subtotalCells.push('E'+r);
          ws.getCell('F'+r).value = { formula: `${incomeTotalCell} * B${catRowStart} / 100` };
          ws.getCell('F'+r).numFmt = '0.00';
          r++;
        }

        ws.getCell('C'+r).value = '支出总计';
        if(subtotalCells.length){
          ws.getCell('D'+r).value = { formula: `SUM(${subtotalCells.join(',')})` };
        } else {
          ws.getCell('D'+r).value = 0;
        }
        ws.getCell('D'+r).numFmt = '0.00';
        const totalExpenseCell = 'D'+r;
        r += 2;

        ws.getCell('C'+r).value = '结余 (收入 - 支出)';
        ws.getCell('D'+r).value = { formula: `${incomeTotalCell} - ${totalExpenseCell}` };
        ws.getCell('D'+r).numFmt = '0.00';
        r+=2;

        ws.getCell('A'+r).value = '分配总百分比（页面计算）';
        ws.getCell('B'+r).value = this.percentTotal;
        r+=1;

        ws.getColumn(1).width = 22;
        ws.getColumn(2).width = 12;
        ws.getColumn(3).width = 26;
        ws.getColumn(4).width = 14;
        ws.getColumn(5).width = 14;
        ws.getColumn(6).width = 18;

        const buf = await wb.xlsx.writeBuffer();
        const blob = new Blob([buf], { type: 'application/octet-stream' });
        const fname = `收入支出规划_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.xlsx`;
        saveAs(blob, fname);
      }catch(err){
        console.error(err);
        alert('导出 Excel 失败：' + (err.message || err));
      }
    },

    saveNowHandler(){ this.saveNow(); alert('已保存到本地'); },
    clearAllConfirm(){ if(confirm('确定要清空所有数据并恢复默认？')){ localStorage.removeItem(this.storageKey); location.reload(); } },

    updateCharts(){
      const incLabels = this.incomes.map(i => i.name || '未命名');
      const incData = this.incomes.map(i => Number(i.amount) || 0);
      const incCtx = document.getElementById('incomeChart').getContext('2d');
      if(this.incomeChart) this.incomeChart.destroy();
      this.incomeChart = new Chart(incCtx, {
        type:'pie',
        data:{ labels:incLabels, datasets:[{ data:incData }] },
        options:{ responsive:true, plugins:{ legend:{position:'bottom'} } }
      });

      const expLabels = this.expenses.map(c => c.name || '未命名');
      const expData = this.expenses.map(c => this.categoryTotal(c));
      const expCtx = document.getElementById('expenseChart').getContext('2d');
      if(this.expenseChart) this.expenseChart.destroy();
      this.expenseChart = new Chart(expCtx, {
        type:'pie',
        data:{ labels:expLabels, datasets:[{ data:expData }] },
        options:{ responsive:true, plugins:{ legend:{position:'bottom'} } }
      });
    }
  },
  watch:{
    incomes: { handler(){ this.triggerSave(); }, deep:true },
    expenses: { handler(){ this.triggerSave(); }, deep:true }
  },
  mounted(){
    this.loadFromStorage();
    this.updateCharts();
    const raw = localStorage.getItem(this.storageKey);
    if(raw){
      try{ const p = JSON.parse(raw); if(p.savedAt) this.lastSaved = new Date(p.savedAt).toLocaleString(); }catch(e){}
    }
    setInterval(()=>{ if(this.autoSave) this.saveNow(); }, 10000);
  }
}).mount('#app');
</script>

</body>
</html>
