<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ä¸ªäººæ”¶å…¥æ”¯å‡ºè§„åˆ’ï¼ˆæœ¬åœ° - V4ï¼‰</title>

<!-- Vue 3 -->
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- ExcelJS (browser) -->
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
<!-- FileSaver for saving generated xlsx -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
:root{
  --primary:#1a4e89; --accent:#3a7bd5; --danger:#c0392b; --muted:#8b9ab3;
}
*{box-sizing:border-box}
body{ font-family:"Microsoft YaHei", Arial, sans-serif; background:#f4f7fb; margin:0; color:#222;}
header{ background: linear-gradient(90deg,var(--primary),var(--accent)); color:#fff; padding:12px 16px; text-align:center; font-size:18px; }
.container{ max-width:1100px; margin:18px auto; background:#fff; border-radius:10px; padding:14px; box-shadow:0 6px 18px rgba(20,30,60,0.06);}
h2{ color:var(--primary); margin:8px 0;}
table{ width:100%; border-collapse:collapse; margin-bottom:10px; font-size:13px; }
th, td{ border:1px solid #e6eef6; padding:6px; vertical-align:middle; }
th{ background:#eaf1f8; text-align:left; padding:8px; font-weight:700;}
.icon-btn{ background:transparent; border:0; padding:6px; cursor:pointer; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; }
.icon-btn svg{ width:18px; height:18px; stroke:#2c3e50; }
.icon-btn.danger svg{ stroke:var(--danger); }
.icon-btn.small{ padding:4px; }
.add-btn{ background:var(--accent); color:#fff; border-radius:6px; padding:6px 10px; cursor:pointer; border:0; }
.input-num{ width:110px; } /* narrow numeric input for ~6 digits */
.input-name{ width:220px; } /* truncated width for vertical fit */
.compact-name{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:220px; display:inline-block; vertical-align:middle; }
.controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
.col { flex:1; min-width:120px; }
.small-note{ font-size:12px; color:var(--muted); }
.chart-wrap{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
.chart-card{ flex:1 1 320px; background:#fafcff; padding:10px; border-radius:8px; border:1px solid #eef5ff; }
.meta{ font-size:13px; color:#666; }
.percent-total{ font-weight:700; }
.file-info{ font-size:12px; color:#666; margin-top:6px; }
.footer-actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px; }
.file-input{ display:none; }
</style>
</head>
<body>
<header>ä¸ªäººæ”¶å…¥æ”¯å‡ºè§„åˆ’ï¼ˆç¦»çº¿å¯ç”¨ - V4ï¼Œå…¼å®¹æ—§æ•°æ®ï¼‰</header>

<div id="app" class="container">
  <div class="row" style="justify-content:space-between; align-items:center;">
    <h2>æ”¶å…¥åŒº</h2>
    <div>
      <button class="add-btn" @click="addIncome">ï¼‹ æ·»åŠ æ”¶å…¥</button>
      <button class="add-btn" style="background:#1a9b5b;margin-left:8px" @click="importJSON">ğŸ“‚ å¯¼å…¥ JSON</button>
      <input id="fileImport" class="file-input" type="file" accept=".json" @change="onFileImport" />
    </div>
  </div>

  <table>
    <thead>
      <tr><th style="width:48%">é¡¹ç›®å</th><th style="width:20%">é‡‘é¢ (RM)</th><th style="width:32%">æ“ä½œ</th></tr>
    </thead>
    <tbody>
      <tr v-for="(inc, i) in incomes" :key="'inc-'+i">
        <td>
          <input class="input-name" v-model="inc.name" :placeholder="'é¡¹ç›®åç§°'" @blur="triggerSave" />
        </td>
        <td>
          <input class="input-num" type="number" min="0" step="1" v-model.number="inc.amount" @input="limitNumber(i,'income')" />
        </td>
        <td>
          <div style="display:flex; gap:6px; align-items:center;">
            <button class="icon-btn small" :title="'ä¸Šç§»'" @click="moveIncomeUp(i)" :disabled="i===0" v-html="icons.arrowUp"></button>
            <button class="icon-btn small" :title="'ä¸‹ç§»'" @click="moveIncomeDown(i)" :disabled="i===incomes.length-1" v-html="icons.arrowDown"></button>
            <button class="icon-btn small danger" :title="'åˆ é™¤'" @click="removeIncome(i)" v-html="icons.trash"></button>
          </div>
        </td>
      </tr>
      <tr v-if="incomes.length===0"><td colspan="3" class="small-note" style="text-align:center">ï¼ˆå½“å‰æ— æ”¶å…¥é¡¹ï¼‰</td></tr>
      <tr>
        <th>æ”¶å…¥æ€»å’Œ</th>
        <td colspan="2">RM {{ totalIncome.toFixed(2) }}</td>
      </tr>
    </tbody>
  </table>

  <div class="row" style="justify-content:space-between; align-items:center; margin-top:6px;">
    <h2>æ”¯å‡ºåŒº</h2>
    <div class="controls">
      <button class="add-btn" @click="addExpenseCategory">ï¼‹ æ·»åŠ åˆ†ç±»</button>
      <button class="add-btn" style="background:#ff8c42" @click="resetDefaultCategories">æ¢å¤é»˜è®¤</button>
      <div class="meta">æ€»åˆ†é…ï¼š<span :class="{'percent-total':true, 'warn': percentTotal!==100}" :style="{color: percentTotal===100? 'green' : (percentTotal>100? 'var(--danger)':'#c67')}">{{ percentTotal }}%</span></div>
    </div>
  </div>

  <table>
    <thead>
      <tr><th style="width:18%">åˆ†ç±»</th><th style="width:12%">æ¯”ä¾‹ (%)</th><th>ç»†é¡¹ï¼ˆåç§° / é‡‘é¢ / æ“ä½œï¼‰</th><th style="width:18%">åˆ†ç±»ï¼šæ”¯å‡º / é¢„ç®—</th></tr>
    </thead>
    <tbody>
      <tr v-for="(cat, ci) in expenses" :key="'cat-'+ci">
        <td style="vertical-align:top;">
          <input class="input-name" v-model="cat.name" @blur="triggerSave" />
          <div style="margin-top:8px;">
            <button class="icon-btn small" :title="'ä¸Šç§»åˆ†ç±»'" @click="moveCategoryUp(ci)" :disabled="ci===0" v-html="icons.arrowUp"></button>
            <button class="icon-btn small" :title="'ä¸‹ç§»åˆ†ç±»'" @click="moveCategoryDown(ci)" :disabled="ci===expenses.length-1" v-html="icons.arrowDown"></button>
            <button class="icon-btn small danger" :title="'åˆ é™¤åˆ†ç±»'" @click="removeCategory(ci)" v-html="icons.trash"></button>
          </div>
        </td>
        <td>
          <input type="number" min="0" max="100" v-model.number="cat.percent" @input="triggerSave" />
        </td>
        <td>
          <table style="width:100%; border:0;">
            <tbody>
              <tr v-for="(it, ii) in cat.items" :key="ci+'-'+ii">
                <td style="width:55%"><input class="input-name" v-model="it.name" placeholder="ç»†é¡¹åç§°" @blur="triggerSave" /></td>
                <td style="width:22%"><input class="input-num" type="number" min="0" step="1" v-model.number="it.amount" @input="limitNumber(ci, 'expense', ii)" /></td>
                <td style="width:23%">
                  <div style="display:flex; gap:6px; align-items:center;">
                    <button class="icon-btn small" :title="'ä¸Šç§»ç»†é¡¹'" @click="moveExpenseItemUp(ci, ii)" :disabled="ii===0" v-html="icons.arrowUp"></button>
                    <button class="icon-btn small" :title="'ä¸‹ç§»ç»†é¡¹'" @click="moveExpenseItemDown(ci, ii)" :disabled="ii===cat.items.length-1" v-html="icons.arrowDown"></button>
                    <button class="icon-btn small danger" :title="'åˆ é™¤ç»†é¡¹'" @click="removeExpenseItem(ci, ii)" v-html="icons.trash"></button>
                  </div>
                </td>
              </tr>
              <tr v-if="cat.items.length===0"><td colspan="3" class="small-note" style="text-align:center">ï¼ˆå°šæ— ç»†é¡¹ï¼‰</td></tr>
              <tr>
                <td colspan="3"><button class="add-btn" @click="addExpenseItem(ci)">ï¼‹ æ·»åŠ ç»†é¡¹</button></td>
              </tr>
              <tr style="background:#fbfdff;">
                <td><strong>å°è®¡</strong></td>
                <td colspan="2">RM {{ categoryTotal(cat).toFixed(2) }} / é¢„ç®— RM {{ budgetAmount(cat).toFixed(2) }}</td>
              </tr>
            </tbody>
          </table>
        </td>
        <td style="vertical-align:top;">
          <div>å·²æ”¯å‡ºï¼šRM {{ categoryTotal(cat).toFixed(2) }}</div>
          <div style="margin-top:8px">é¢„ç®—ï¼šRM {{ budgetAmount(cat).toFixed(2) }}</div>
        </td>
      </tr>
    </tbody>
    <tfoot>
      <tr style="background:#eef7ff;">
        <th>æ”¯å‡ºæ€»è®¡</th>
        <td colspan="3">RM {{ totalExpense.toFixed(2) }}</td>
      </tr>
      <tr>
        <th>ç»“ä½™</th>
        <td colspan="3" :style="{color:(totalIncome - totalExpense)>=0 ? 'green':'var(--danger)'}">
          {{ (totalIncome - totalExpense)>=0 ? 'ç›ˆä½™' : 'èµ¤å­—' }}ï¼šRM {{ (totalIncome - totalExpense).toFixed(2) }}
        </td>
      </tr>
    </tfoot>
  </table>

  <div class="footer-actions">
    <button class="add-btn" @click="saveNow" title="ä¿å­˜åˆ° localStorage">ğŸ’¾ ä¿å­˜</button>
    <button class="add-btn" style="background:#6b8" @click="exportExcel" title="å¯¼å‡ºä¸º Excel (.xlsx)">â¬‡ï¸ å¯¼å‡º Excel</button>
    <button class="add-btn" style="background:#7cc" @click="exportJSON" title="å¯¼å‡º JSON å¤‡ä»½">ğŸ“¤ å¯¼å‡º JSON</button>
    <button class="add-btn" style="background:#888" @click="showStorage" title="æ˜¾ç¤ºæœ¬åœ°å‚¨å­˜ (raw)">ğŸ“ æ˜¾ç¤ºå‚¨å­˜</button>
    <button class="add-btn" style="background:var(--danger)" @click="clearAllConfirm">âš ï¸ æ¸…ç©ºå¹¶æ¢å¤é»˜è®¤</button>
    <div style="flex:1"></div>
    <div class="file-info">
      è‡ªåŠ¨ä¿å­˜ï¼š<strong>{{ autoSave ? 'å¼€å¯' : 'å…³é—­' }}</strong> Â· æœ€åä¿å­˜ï¼š<strong>{{ lastSaved ? lastSaved : 'â€”' }}</strong><br>
      Storage key: <code>{{ storageKey }}</code>
    </div>
  </div>

  <div class="chart-wrap">
    <div class="chart-card">
      <h3>æ”¶å…¥åˆ†å¸ƒ</h3>
      <canvas id="incomeChart" width="400" height="260"></canvas>
    </div>
    <div class="chart-card">
      <h3>æ”¯å‡ºç»“æ„ï¼ˆåˆ†ç±»ï¼‰</h3>
      <canvas id="expenseChart" width="400" height="260"></canvas>
    </div>
  </div>
</div>

<script>
const { createApp } = Vue;

const ICONS = {
  plus: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>',
  trash: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>',
  arrowUp: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19V5"/><path d="M5 12l7-7 7 7"/></svg>',
  arrowDown: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M19 12l-7 7-7-7"/></svg>'
};

createApp({
  data(){
    return {
      // include multiple legacy keys for compatibility
      storageKey: 'local_finance_planner_v2',
      legacyKeys: ['local_finance_planner_v1','local_finance_planner','incomeExpenseData','plannerData','finance_backup'],
      autoSave: true,
      lastSaved: null,
      incomes: [
        {name:'å·¥èµ„', amount:5000},
        {name:'å‰¯ä¸š', amount:800}
      ],
      expenses: [
        { name:'æŠ•èµ„', percent:25, items:[ {name:'è‚¡ç¥¨', amount:0} ] },
        { name:'è´·æ¬¾', percent:36, items:[ {name:'æˆ¿è´·', amount:0} ] },
        { name:'æ‰¿æ‹…', percent:25, items:[ {name:'çˆ¶æ¯/ä¿é™©', amount:0} ] },
        { name:'ç”Ÿæ´»è´¹', percent:12, items:[ {name:'é£Ÿç‰©/äº¤é€š', amount:0} ] },
        { name:'å…¶å®ƒ', percent:2, items:[ {name:'æ‚é¡¹', amount:0} ] }
      ],
      incomeChart:null,
      expenseChart:null,
      icons: ICONS
    }
  },
  computed:{
    totalIncome(){ return this.incomes.reduce((s,i)=> s + (Number(i.amount)||0), 0); },
    totalExpense(){ return this.expenses.reduce((s,c)=> s + this.categoryTotal(c), 0); },
    percentTotal(){ return Math.round(this.expenses.reduce((s,c)=> s + (Number(c.percent)||0), 0)); }
  },
  methods:{
    limitNumber(idxOrCat, type, subIdx){
      if(type === 'income'){
        this.incomes[idxOrCat].amount = Math.max(0, Math.min(999999, Number(this.incomes[idxOrCat].amount) || 0));
      } else if(type === 'expense'){
        this.expenses[idxOrCat].items[subIdx].amount = Math.max(0, Math.min(999999, Number(this.expenses[idxOrCat].items[subIdx].amount) || 0));
      }
      this.triggerSave();
    },
    addIncome(){ this.incomes.push({name:'', amount:0}); this.triggerSave(); },
    removeIncome(i){ if(confirm('åˆ é™¤è¯¥æ”¶å…¥é¡¹ï¼Ÿ')){ this.incomes.splice(i,1); this.triggerSave(); } },
    moveIncomeUp(i){ if(i>0){ [this.incomes[i-1], this.incomes[i]] = [this.incomes[i], this.incomes[i-1]]; this.triggerSave(); } },
    moveIncomeDown(i){ if(i < this.incomes.length-1){ [this.incomes[i+1], this.incomes[i]] = [this.incomes[i], this.incomes[i+1]]; this.triggerSave(); } },

    addExpenseCategory(){ this.expenses.push({name:'æ–°åˆ†ç±»', percent:0, items:[{name:'ç»†é¡¹', amount:0}]}); this.triggerSave(); },
    removeCategory(ci){ if(confirm('åˆ é™¤åˆ†ç±»åŠå…¶ç»†é¡¹ï¼Ÿ')){ this.expenses.splice(ci,1); this.triggerSave(); } },
    moveCategoryUp(ci){ if(ci>0){ [this.expenses[ci-1], this.expenses[ci]] = [this.expenses[ci], this.expenses[ci-1]]; this.triggerSave(); } },
    moveCategoryDown(ci){ if(ci < this.expenses.length-1){ [this.expenses[ci+1], this.expenses[ci]] = [this.expenses[ci], this.expenses[ci+1]]; this.triggerSave(); } },
    resetDefaultCategories(){ if(confirm('æ¢å¤é»˜è®¤äº”ä¸ªåˆ†ç±»ï¼Ÿä¼šæ›¿æ¢å½“å‰åˆ†ç±»ã€‚')){ this.expenses = [
      { name:'æŠ•èµ„', percent:25, items:[ {name:'è‚¡ç¥¨', amount:0} ] },
      { name:'è´·æ¬¾', percent:36, items:[ {name:'æˆ¿è´·', amount:0} ] },
      { name:'æ‰¿æ‹…', percent:25, items:[ {name:'çˆ¶æ¯/ä¿é™©', amount:0} ] },
      { name:'ç”Ÿæ´»è´¹', percent:12, items:[ {name:'é£Ÿç‰©/äº¤é€š', amount:0} ] },
      { name:'å…¶å®ƒ', percent:2, items:[ {name:'æ‚é¡¹', amount:0} ] }
    ]; this.triggerSave(); } },

    addExpenseItem(ci){ this.expenses[ci].items.push({name:'', amount:0}); this.triggerSave(); },
    removeExpenseItem(ci, ii){ if(confirm('åˆ é™¤è¯¥æ”¯å‡ºç»†é¡¹ï¼Ÿ')){ this.expenses[ci].items.splice(ii,1); this.triggerSave(); } },
    moveExpenseItemUp(ci, ii){ if(ii>0){ const arr = this.expenses[ci].items; [arr[ii-1], arr[ii]] = [arr[ii], arr[ii-1]]; this.triggerSave(); } },
    moveExpenseItemDown(ci, ii){ const arr = this.expenses[ci].items; if(ii < arr.length-1){ [arr[ii+1], arr[ii]] = [arr[ii], arr[ii+1]]; this.triggerSave(); } },

    categoryTotal(cat){ return (cat.items || []).reduce((s,it)=> s + (Number(it.amount)||0), 0); },
    budgetAmount(cat){ return this.totalIncome * (Number(cat.percent)||0) / 100; },

    triggerSave(){ if(this.autoSave) this.saveNow(); this.updateCharts(); },
    saveNow(){
      try{
        const payload = { version:4, incomes:this.incomes, expenses:this.expenses, savedAt: new Date().toISOString() };
        localStorage.setItem(this.storageKey, JSON.stringify(payload));
        this.lastSaved = new Date().toLocaleString();
      }catch(e){ console.error('save error', e); alert('ä¿å­˜å¤±è´¥ï¼š' + e.message); }
    },
    loadFromStorage(){
      try{
        // try primary key first
        const raw = localStorage.getItem(this.storageKey);
        if(raw){
          const p = JSON.parse(raw);
          // simple validation
          if(p && (p.incomes || p.expenses)){
            // if older version numbers, migrate if needed
            this.migrateAndLoad(p);
            return;
          }
        }
        // try legacy keys
        for(const k of this.legacyKeys){
          const rv = localStorage.getItem(k);
          if(rv){
            try{
              const parsed = JSON.parse(rv);
              if(parsed && (parsed.incomes || parsed.expenses)){
                // migrate and save into new key
                this.migrateAndLoad(parsed);
                this.saveNow();
                return;
              }
            }catch(e){ console.warn('parse legacy key failed', k, e); }
          }
        }
        // nothing found; keep defaults
      }catch(e){ console.error('load error', e); }
    },
    migrateAndLoad(parsed){
      // Handle various possible shapes
      // If parsed has version and is >=4, assume compatible
      if(parsed.version && parsed.version >= 4){
        this.incomes = parsed.incomes || this.incomes;
        this.expenses = parsed.expenses || this.expenses;
        this.lastSaved = parsed.savedAt ? new Date(parsed.savedAt).toLocaleString() : null;
        return;
      }
      // If older version or no version, attempt to map fields
      const incomes = parsed.incomes || parsed.incomeList || parsed.sources || [];
      const expenses = parsed.expenses || parsed.expenseList || parsed.outcomes || [];
      // Ensure structure: categories have name, percent, items[]
      const normExpenses = expenses.map(e=>{
        if(e.items) return e;
        if(e.subitems) return { name: e.name||'åˆ†ç±»', percent: e.percent||0, items: e.subitems };
        if(e.name && e.amount !== undefined) return { name: e.name, percent: e.percent||0, items:[{name:e.name, amount:e.amount||0}] };
        return { name: e.name||'åˆ†ç±»', percent: e.percent||0, items: e.items||[] };
      });
      this.incomes = incomes;
      this.expenses = normExpenses.length ? normExpenses : this.expenses;
      this.lastSaved = parsed.savedAt ? new Date(parsed.savedAt).toLocaleString() : null;
    },

    showStorage(){
      const raw = localStorage.getItem(this.storageKey) || 'ï¼ˆæ— ï¼‰';
      const w = window.open('', '_blank');
      w.document.title = 'æœ¬åœ°å‚¨å­˜å†…å®¹';
      w.document.body.innerHTML = '<pre>' + raw.replace(/</g,'&lt;') + '</pre>';
    },

        // import JSON (file input)
    importJSON(){
      document.getElementById('fileImport').value = null;
      document.getElementById('fileImport').click();
    },
    onFileImport(evt){
      const f = evt.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try{
          const parsed = JSON.parse(e.target.result);
          if(!parsed) throw new Error('JSON æ— æ•ˆ');
          if(parsed.version && parsed.version >= 2){
            if(confirm('é€‰æ‹©ã€Œç¡®å®šã€å°†ç”¨å¯¼å…¥çš„æ•°æ®æ›¿æ¢å½“å‰å¹¶ä¿å­˜ï¼›æŒ‰ã€Œå–æ¶ˆã€åˆ™åˆå¹¶åˆ°å½“å‰æ•°æ®ï¼ˆä¿ç•™ç°æœ‰é¡¹ï¼‰ã€‚')){
              this.incomes = parsed.incomes || [];
              this.expenses = parsed.expenses || [];
            } else {
              this.incomes = this.incomes.concat(parsed.incomes || []);
              this.expenses = this.expenses.concat(parsed.expenses || []);
            }
            this.saveNow();
            this.updateCharts();
            alert('å¯¼å…¥å®Œæˆ');
            return;
          }
          if(parsed.incomes || parsed.expenses){
            if(confirm('å¯¼å…¥æ•°æ®æ˜¯å¦æ›¿æ¢å½“å‰ï¼Ÿé€‰æ‹©ã€Œç¡®å®šã€æ›¿æ¢ï¼Œã€Œå–æ¶ˆã€åˆå¹¶ã€‚')){
              this.incomes = parsed.incomes || [];
              this.expenses = parsed.expenses || [];
            } else {
              this.incomes = this.incomes.concat(parsed.incomes || []);
              this.expenses = this.expenses.concat(parsed.expenses || []);
            }
            this.saveNow();
            this.updateCharts();
            alert('å¯¼å…¥å®Œæˆï¼ˆå…¼å®¹æ—§ç»“æ„ï¼‰');
            return;
          }
          alert('æ— æ³•è¯†åˆ«çš„ JSON æ ¼å¼');
        }catch(err){
          alert('å¯¼å…¥å¤±è´¥ï¼š' + err.message);
        }
      };
      reader.readAsText(f);
    },

    exportJSON(){
      try{
        const payload = { version:4, incomes:this.incomes, expenses:this.expenses, savedAt:new Date().toISOString() };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
        const fname = `income_expense_backup_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
        saveAs(blob, fname);
      }catch(e){ alert('å¯¼å‡ºJSONå¤±è´¥ï¼š' + e.message); }
    },

    async exportExcel(){
      try{
        const wb = new ExcelJS.Workbook();
        const ws = wb.addWorksheet('æ”¶å…¥æ”¯å‡ºè§„åˆ’');

        const title = `ä¸ªäººç†è´¢è§„åˆ’ by Hau Hau - ${new Date().toLocaleString()}`;
        ws.mergeCells('A1','F1');
        ws.getCell('A1').value = title;
        ws.getCell('A1').font = { size:14, bold:true };
        ws.getRow(1).height = 24;

        let r = 3;
        ws.getCell('A'+r).value = 'æ”¶å…¥åŒº';
        ws.getCell('A'+r).font = { bold:true };
        r++;
        ws.getRow(r).values = ['é¡¹ç›®', 'é‡‘é¢ (RM)'];
        ws.getRow(r).eachCell(c => c.font = { bold:true });
        r++;

        const incStart = r;
        for(const inc of this.incomes){
          ws.getCell('A'+r).value = inc.name || '';
          ws.getCell('B'+r).value = Number(inc.amount) || 0;
          r++;
        }
        const incEnd = r-1;
        ws.getCell('A'+r).value = 'æ”¶å…¥æ€»è®¡';
        if(incEnd >= incStart){
          ws.getCell('B'+r).value = { formula: `SUM(B${incStart}:B${incEnd})` };
        } else {
          ws.getCell('B'+r).value = 0;
        }
        const incomeTotalCell = 'B'+r;
        ws.getCell(incomeTotalCell).numFmt = '0.00';
        r += 2;

        ws.getCell('A'+r).value = 'æ”¯å‡ºåŒº';
        ws.getCell('A'+r).font = { bold:true };
        r++;
        ws.getRow(r).values = ['åˆ†ç±»','æ¯”ä¾‹ (%)','ç»†é¡¹','é‡‘é¢ (RM)','åˆ†ç±»å°è®¡ (å…¬å¼)','é¢„ç®— (å…¬å¼)'];
        ws.getRow(r).eachCell(c => c.font = { bold:true });
        r++;

        const subtotalCells = [];
        for(const cat of this.expenses){
          const catRowStart = r;
          ws.getCell('A'+r).value = cat.name || '';
          ws.getCell('B'+r).value = Number(cat.percent) || 0;
          if((cat.items||[]).length > 0){
            ws.getCell('C'+r).value = cat.items[0].name || '';
            ws.getCell('D'+r).value = Number(cat.items[0].amount) || 0;
            r++;
            for(let i=1;i<cat.items.length;i++){
              ws.getCell('C'+r).value = cat.items[i].name || '';
              ws.getCell('D'+r).value = Number(cat.items[i].amount) || 0;
              r++;
            }
          } else {
              ws.getCell('C'+r).value = '';
              ws.getCell('D'+r).value = 0;
              r++;
          }
          const catRowEnd = r-1;
          ws.getCell('E'+r).value = { formula: `SUM(D${catRowStart}:D${catRowEnd})` };
          subtotalCells.push('E'+r);
          ws.getCell('F'+r).value = { formula: `${incomeTotalCell} * B${catRowStart} / 100` };
          ws.getCell('F'+r).numFmt = '0.00';
          r++;
        }

        ws.getCell('C'+r).value = 'æ”¯å‡ºæ€»è®¡';
        if(subtotalCells.length){
          ws.getCell('D'+r).value = { formula: `SUM(${subtotalCells.join(',')})` };
        } else {
          ws.getCell('D'+r).value = 0;
        }
        ws.getCell('D'+r).numFmt = '0.00';
        const totalExpenseCell = 'D'+r;
        r += 2;

        ws.getCell('C'+r).value = 'ç»“ä½™ (æ”¶å…¥ - æ”¯å‡º)';
        ws.getCell('D'+r).value = { formula: `${incomeTotalCell} - ${totalExpenseCell}` };
        ws.getCell('D'+r).numFmt = '0.00';
        r+=2;

        ws.getCell('A'+r).value = 'åˆ†é…æ€»ç™¾åˆ†æ¯”ï¼ˆé¡µé¢è®¡ç®—ï¼‰';
        ws.getCell('B'+r).value = this.percentTotal;
        r+=1;

        ws.getColumn(1).width = 22;
        ws.getColumn(2).width = 12;
        ws.getColumn(3).width = 26;
        ws.getColumn(4).width = 14;
        ws.getColumn(5).width = 14;
        ws.getColumn(6).width = 18;

        const buf = await wb.xlsx.writeBuffer();
        const blob = new Blob([buf], { type: 'application/octet-stream' });
        const fname = `æ”¶å…¥æ”¯å‡ºè§„åˆ’_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.xlsx`;
        saveAs(blob, fname);
      }catch(err){
        console.error(err);
        alert('å¯¼å‡º Excel å¤±è´¥ï¼š' + (err.message || err));
      }
    },

    saveNowHandler(){ this.saveNow(); alert('å·²ä¿å­˜åˆ°æœ¬åœ°'); },
    clearAllConfirm(){ if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å¹¶æ¢å¤é»˜è®¤ï¼Ÿ')){ localStorage.removeItem(this.storageKey); location.reload(); } },

    updateCharts(){
      const incLabels = this.incomes.map(i => i.name || 'æœªå‘½å');
      const incData = this.incomes.map(i => Number(i.amount) || 0);
      const incCtx = document.getElementById('incomeChart').getContext('2d');
      if(this.incomeChart) this.incomeChart.destroy();
      this.incomeChart = new Chart(incCtx, {
        type:'pie',
        data:{ labels:incLabels, datasets:[{ data:incData }] },
        options:{ responsive:true, plugins:{ legend:{position:'bottom'} } }
      });

      const expLabels = this.expenses.map(c => c.name || 'æœªå‘½å');
      const expData = this.expenses.map(c => this.categoryTotal(c));
      const expCtx = document.getElementById('expenseChart').getContext('2d');
      if(this.expenseChart) this.expenseChart.destroy();
      this.expenseChart = new Chart(expCtx, {
        type:'pie',
        data:{ labels:expLabels, datasets:[{ data:expData }] },
        options:{ responsive:true, plugins:{ legend:{position:'bottom'} } }
      });
    }
  },
  watch:{
    incomes: { handler(){ this.triggerSave(); }, deep:true },
    expenses: { handler(){ this.triggerSave(); }, deep:true }
  },
  mounted(){
    this.loadFromStorage();
    this.updateCharts();
    const raw = localStorage.getItem(this.storageKey);
    if(raw){
      try{ const p = JSON.parse(raw); if(p.savedAt) this.lastSaved = new Date(p.savedAt).toLocaleString(); }catch(e){}
    }
    setInterval(()=>{ if(this.autoSave) this.saveNow(); }, 10000);
  }
}).mount('#app');
</script>

</body>
</html>
